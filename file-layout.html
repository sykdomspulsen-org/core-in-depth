<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>3 File Layout | Sykdomspulsen Core in Depth</title>
<meta name="author" content="members of the Sykdomspulsen Team">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="3 File Layout | Sykdomspulsen Core in Depth">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3 File Layout | Sykdomspulsen Core in Depth">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><meta name="description" content="3.1 Introduction Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
<meta property="og:description" content="3.1 Introduction Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
<meta name="twitter:description" content="3.1 Introduction Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="https://docs.sykdomspulsen.no" title="">docs.sykdomspulsen.no</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Sykdomspulsen Core in Depth</a></li>
<li><a class="" href="authors.html">Authors</a></li>
<li><a class="" href="db-schemas.html"><span class="header-section-number">1</span> DB Schemas</a></li>
<li><a class="" href="tasks.html"><span class="header-section-number">2</span> Tasks</a></li>
<li><a class="active" href="file-layout.html"><span class="header-section-number">3</span> File Layout</a></li>
<li><a class="" href="tutorial-1-introduction.html"><span class="header-section-number">4</span> Tutorial 1: Introduction</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="file-layout" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> File Layout<a class="anchor" aria-label="anchor" href="#file-layout"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-2" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at <a href="https://github.com/sykdomspulsen-org/scskeleton" class="uri">https://github.com/sykdomspulsen-org/scskeleton</a></p>
<p>We suggest that you clone this GitHub repo to your server, and then do a global find/replace on <code>scskeleton</code> with the name you want for your R package.</p>
<p>Descriptions of the required files/functions are detailed below.</p>
</div>
<div id="env_and_namespace.r" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> 00_env_and_namespace.r<a class="anchor" aria-label="anchor" href="#env_and_namespace.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/00_env_and_namespace.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/00_env_and_namespace.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/00_env_and_namespace.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 00_env_and_namespace.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Use roxygen2 to import ggplot2, data.table, %&gt;%, and %&lt;&gt;% into the namespace,
##  8 | #   because these are the most commonly used packages/functions.
##  9 | #
## 10 | # PURPOSE 2:
## 11 | #   Declaring our own "tm_run_task" inside this package, as a wrapper around
## 12 | #   sc::tm_run_task.
## 13 | #
## 14 | #   We cannot run sc::tm_run_task directly, because we need to load all of the
## 15 | #   database connections, db schemas, tasks, etc. *before* we run the task.
## 16 | #   Hence, this wrapper ensures that all of this package's configs files are
## 17 | #   loaded via OURPACKAGE::.onLoad() first, and then sc::tm_run_task can run.
## 18 | #
## 19 | # PURPOSE 3:
## 20 | #   Declaration of environments that can be used globally.
## 21 | #
## 22 | # PURPOSE 4:
## 23 | #   Fix issues/integration with other packages.
## 24 | #
## 25 | #   Most notably is the issue with rmarkdown, where an error is thrown when
## 26 | #   rendering multiple rmarkdown documents in parallel.
## 27 | #
## 28 | # ******************************************************************************
## 29 | # ******************************************************************************
## 30 | 
## 31 | #' @import ggplot2
## 32 | #' @import data.table
## 33 | #' @importFrom magrittr %&gt;% %&lt;&gt;%
## 34 | 1
## 35 | 
## 36 | #' Shortcut to run task
## 37 | #'
## 38 | #' This task is needed to ensure that all the definitions/db schemas/tasks/etc
## 39 | #' are loaded from the package scskeleton. We cannot run sc::tm_run_task directly,
## 40 | #' because we need to load all of the database connections, db schemas, tasks,
## 41 | #' etc. *before* we run the task. Hence, this wrapper ensures that all of this
## 42 | #' package's configs files are loaded via OURPACKAGE::.onLoad() first, and then
## 43 | #' sc::tm_run_task can run.
## 44 | #'
## 45 | #' @param task_name Name of the task
## 46 | #' @param index_plan Not used
## 47 | #' @param index_analysis Not used
## 48 | #' @export
## 49 | tm_run_task &lt;- function(task_name, index_plan = NULL, index_analysis = NULL) {
## 50 |   sc::tm_run_task(
## 51 |     task_name = task_name,
## 52 |     index_plan = index_plan,
## 53 |     index_analysis = index_analysis
## 54 |   )
## 55 | }
## 56 | 
## 57 | #' Declaration of environments that can be used globally
## 58 | #' @export config
## 59 | config &lt;- new.env()
## 60 | 
## 61 | # https://github.com/rstudio/rmarkdown/issues/1632
## 62 | # An error is thrown when rendering multiple rmarkdown documents in parallel.
## 63 | clean_tmpfiles_mod &lt;- function() {
## 64 |   # message("Calling clean_tmpfiles_mod()")
## 65 | }</code></pre>
</div>
<div id="definitions.r" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> 01_definitions.r<a class="anchor" aria-label="anchor" href="#definitions.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/01_definitions.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/01_definitions.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/01_definitions.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 01_definitions.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Set global definitions that are used throughout the package, and further
##  8 | #   (e.g. in shiny/plumber creations).
##  9 | #
## 10 | #   Examples of global definitions are:
## 11 | #     - Border years
## 12 | #     - Age definitions
## 13 | #     - Diagnosis mappings (e.g. "R80" = "Influenza")
## 14 | #
## 15 | # ******************************************************************************
## 16 | # ******************************************************************************
## 17 | 
## 18 | #' Set global definitions
## 19 | set_definitions &lt;- function() {
## 20 | 
## 21 |   # Norway's last redistricting occurred 2020-01-01
## 22 |   config$border &lt;- 2020
## 23 | 
## 24 |   # fhidata needs to know which border is in use
## 25 |   # fhidata should also replace the population of 1900 with the current year,
## 26 |   # because year = 1900 is shorthand for granularity_geo = "total".
## 27 |   # This means that it is more appropriate to use the current year's population
## 28 |   # for year = 1900.
## 29 |   fhidata::set_config(
## 30 |     border = config$border,
## 31 |     use_current_year_as_1900_pop = TRUE
## 32 |   )
## 33 | }</code></pre>
</div>
<div id="permissions.r" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> 02_permissions.r<a class="anchor" aria-label="anchor" href="#permissions.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/02_permissions.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/02_permissions.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/02_permissions.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 02_permissions.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Set permissions that can be used in this package.
##  8 | #
##  9 | # PURPOSE 2:
## 10 | #   Permissions are a way of ensuring that a task only runs once per hour/day/week.
## 11 | #   This can be useful when you want to be 100% sure that you don't want to spam
## 12 | #   emails to your recipients.
## 13 | #
## 14 | # PURPOSE 3:
## 15 | #   Permissions can also be used to differentiate between "production days" and
## 16 | #   "preliminary days". This can be useful when you have different email lists
## 17 | #   for production days (everyone) and preliminary days (a smaller group).
## 18 | #
## 19 | # ******************************************************************************
## 20 | # ******************************************************************************
## 21 | 
## 22 | set_permissions &lt;- function() {
## 23 |   # sc::add_permission(
## 24 |   #   name = "khtemails_send_emails",
## 25 |   #   permission = sc::Permission$new(
## 26 |   #     key = "khtemails_send_emails",
## 27 |   #     value = as.character(lubridate::today()),  # one time per day
## 28 |   #     production_days = c(3) # wed, send to everyone, otherwise prelim
## 29 |   #   )
## 30 |   # )
## 31 | }</code></pre>
</div>
<div id="db_schemas.r" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> 03_db_schemas.r<a class="anchor" aria-label="anchor" href="#db_schemas.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/03_db_schemas.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/03_db_schemas.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/03_db_schemas.r
## 
##   1 | # ******************************************************************************
##   2 | # ******************************************************************************
##   3 | #
##   4 | # 03_db_schemas.r
##   5 | #
##   6 | # PURPOSE 1:
##   7 | #   Set db schemas that are used throughout the package.
##   8 | #
##   9 | #   These are basically all of the database tables that you will be writing to,
##  10 | #   and reading from.
##  11 | #
##  12 | # ******************************************************************************
##  13 | # ******************************************************************************
##  14 | 
##  15 | set_db_schemas &lt;- function() {
##  16 |   # __________ ----
##  17 |   # Weather  ----
##  18 |   ## &gt; anon_example_weather_rawdata ----
##  19 |   sc::add_schema_v8(
##  20 |     name_access = c("anon"),
##  21 |     name_grouping = "example_weather",
##  22 |     name_variant = "rawdata",
##  23 |     db_configs = sc::config$db_configs,
##  24 |     field_types =  c(
##  25 |       "granularity_time" = "TEXT",
##  26 |       "granularity_geo" = "TEXT",
##  27 |       "country_iso3" = "TEXT",
##  28 |       "location_code" = "TEXT",
##  29 |       "border" = "INTEGER",
##  30 |       "age" = "TEXT",
##  31 |       "sex" = "TEXT",
##  32 | 
##  33 |       "date" = "DATE",
##  34 | 
##  35 |       "isoyear" = "INTEGER",
##  36 |       "isoweek" = "INTEGER",
##  37 |       "isoyearweek" = "TEXT",
##  38 |       "season" = "TEXT",
##  39 |       "seasonweek" = "DOUBLE",
##  40 | 
##  41 |       "calyear" = "INTEGER",
##  42 |       "calmonth" = "INTEGER",
##  43 |       "calyearmonth" = "TEXT",
##  44 | 
##  45 |       "temp_max" = "DOUBLE",
##  46 |       "temp_min" = "DOUBLE",
##  47 |       "precip" = "DOUBLE"
##  48 |     ),
##  49 |     keys = c(
##  50 |       "granularity_time",
##  51 |       "location_code",
##  52 |       "date",
##  53 |       "age",
##  54 |       "sex"
##  55 |     ),
##  56 |     censors = list(
##  57 |       anon = list(
##  58 | 
##  59 |       )
##  60 |     ),
##  61 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
##  62 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
##  63 |     info = "This db table is used for..."
##  64 |   )
##  65 | 
##  66 |   ## &gt; anon_example_weather_data ----
##  67 |   sc::add_schema_v8(
##  68 |     name_access = c("anon"),
##  69 |     name_grouping = "example_weather",
##  70 |     name_variant = "data",
##  71 |     db_configs = sc::config$db_configs,
##  72 |     field_types =  c(
##  73 |       "granularity_time" = "TEXT",
##  74 |       "granularity_geo" = "TEXT",
##  75 |       "country_iso3" = "TEXT",
##  76 |       "location_code" = "TEXT",
##  77 |       "border" = "INTEGER",
##  78 |       "age" = "TEXT",
##  79 |       "sex" = "TEXT",
##  80 | 
##  81 |       "date" = "DATE",
##  82 | 
##  83 |       "isoyear" = "INTEGER",
##  84 |       "isoweek" = "INTEGER",
##  85 |       "isoyearweek" = "TEXT",
##  86 |       "season" = "TEXT",
##  87 |       "seasonweek" = "DOUBLE",
##  88 | 
##  89 |       "calyear" = "INTEGER",
##  90 |       "calmonth" = "INTEGER",
##  91 |       "calyearmonth" = "TEXT",
##  92 | 
##  93 |       "temp_max" = "DOUBLE",
##  94 |       "temp_min" = "DOUBLE",
##  95 |       "precip" = "DOUBLE"
##  96 |     ),
##  97 |     keys = c(
##  98 |       "granularity_time",
##  99 |       "location_code",
## 100 |       "date",
## 101 |       "age",
## 102 |       "sex"
## 103 |     ),
## 104 |     censors = list(
## 105 |       anon = list(
## 106 | 
## 107 |       )
## 108 |     ),
## 109 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
## 110 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
## 111 |     info = "This db table is used for..."
## 112 |   )
## 113 | }</code></pre>
</div>
<div id="tasks.r" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> 04_tasks.r<a class="anchor" aria-label="anchor" href="#tasks.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/04_tasks.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/04_tasks.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/04_tasks.r
## 
##   1 | # ******************************************************************************
##   2 | # ******************************************************************************
##   3 | #
##   4 | # 04_tasks.r
##   5 | #
##   6 | # PURPOSE 1:
##   7 | #   Set all the tasks that are run by the package.
##   8 | #
##   9 | #   These are basically all of the "things" that you want to do.
##  10 | #   E.g. Downloading data, cleaning data, importing data, analyzing data,
##  11 | #   making Excel files, making docx/pdf reports, sending emails, etc.
##  12 | #
##  13 | # ******************************************************************************
##  14 | # ******************************************************************************
##  15 | 
##  16 | set_tasks &lt;- function() {
##  17 |   # __________ ----
##  18 |   # Weather  ----
##  19 |   ## &gt; weather_download_and_import_rawdata ----
##  20 |   # tm_run_task("weather_download_and_import_rawdata")
##  21 |   sc::add_task_from_config_v8(
##  22 |     name_grouping = "weather",
##  23 |     name_action = "download_and_import_rawdata",
##  24 |     name_variant = NULL,
##  25 |     cores = 1,
##  26 |     plan_analysis_fn_name = NULL,
##  27 |     for_each_plan = plnr::expand_list(
##  28 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("municip")]$location_code
##  29 |     ),
##  30 |     for_each_analysis = NULL,
##  31 |     universal_argset = NULL,
##  32 |     upsert_at_end_of_each_plan = FALSE,
##  33 |     insert_at_end_of_each_plan = FALSE,
##  34 |     action_fn_name = "scskeleton::weather_download_and_import_rawdata_action",
##  35 |     data_selector_fn_name = "scskeleton::weather_download_and_import_rawdata_data_selector",
##  36 |     schema = list(
##  37 |       # input
##  38 | 
##  39 |       # output
##  40 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata
##  41 |     ),
##  42 |     info = "This task downloads and imports the raw weather data from MET's API at the municipal level"
##  43 |   )
##  44 | 
##  45 |   ## &gt; weather_clean_data ----
##  46 |   # tm_run_task("weather_clean_data")
##  47 |   sc::add_task_from_config_v8(
##  48 |     name_grouping = "weather",
##  49 |     name_action = "clean_data",
##  50 |     name_variant = NULL,
##  51 |     cores = 1,
##  52 |     plan_analysis_fn_name = NULL,
##  53 |     for_each_plan = plnr::expand_list(
##  54 |       x = 1
##  55 |     ),
##  56 |     for_each_analysis = NULL,
##  57 |     universal_argset = NULL,
##  58 |     upsert_at_end_of_each_plan = FALSE,
##  59 |     insert_at_end_of_each_plan = FALSE,
##  60 |     action_fn_name = "scskeleton::weather_clean_data_action",
##  61 |     data_selector_fn_name = "scskeleton::weather_clean_data_data_selector",
##  62 |     schema = list(
##  63 |       # input
##  64 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata,
##  65 | 
##  66 |       # output
##  67 |       "anon_example_weather_data" = sc::config$schemas$anon_example_weather_data
##  68 |     ),
##  69 |     info = "This task cleans the raw data and aggregates it to county and national level"
##  70 |   )
##  71 | 
##  72 |   ## &gt; weather_clean_data ----
##  73 |   # tm_run_task("weather_export_plots")
##  74 |   sc::add_task_from_config_v8(
##  75 |     name_grouping = "weather",
##  76 |     name_action = "export_plots",
##  77 |     name_variant = NULL,
##  78 |     cores = 1,
##  79 |     plan_analysis_fn_name = NULL,
##  80 |     for_each_plan = plnr::expand_list(
##  81 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("county")]$location_code
##  82 |     ),
##  83 |     for_each_analysis = NULL,
##  84 |     universal_argset = list(
##  85 |       output_dir = tempdir(),
##  86 |       output_filename = "weather_{argset$location_code}.png",
##  87 |       output_absolute_path = fs::path("{argset$output_dir}", "{argset$output_filename}")
##  88 |     ),
##  89 |     upsert_at_end_of_each_plan = FALSE,
##  90 |     insert_at_end_of_each_plan = FALSE,
##  91 |     action_fn_name = "scskeleton::weather_export_plots_action",
##  92 |     data_selector_fn_name = "scskeleton::weather_export_plots_data_selector",
##  93 |     schema = list(
##  94 |       # input
##  95 |       "anon_example_weather_data" = sc::config$schemas$anon_example_weather_data
##  96 | 
##  97 |       # output
##  98 |     ),
##  99 |     info = "This task ploduces plots"
## 100 |   )
## 101 | }</code></pre>
</div>
<div id="deliverables.r" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> 05_deliverables.r<a class="anchor" aria-label="anchor" href="#deliverables.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/05_deliverables.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/05_deliverables.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/05_deliverables.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 05_deliverables.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Set all the deliverables that team members are supposed to manually do/check
##  8 | #   every day/week/month.
##  9 | #
## 10 | # ******************************************************************************
## 11 | # ******************************************************************************
## 12 | 
## 13 | set_deliverables &lt;- function() {
## 14 | 
## 15 | }</code></pre>
</div>
<div id="config.r" class="section level2" number="3.8">
<h2>
<span class="header-section-number">3.8</span> 06_config.r<a class="anchor" aria-label="anchor" href="#config.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/06_config.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/06_config.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/06_config.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 06_config.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Call all the functions defined in 01, 02, 03, 04, and 05 in the correct order.
##  8 | #
##  9 | # PURPOSE 2:
## 10 | #   Set all necessary configs that do not belong anywhere else.
## 11 | #
## 12 | #   E.g. Formatting for progress bars.
## 13 | #
## 14 | # ******************************************************************************
## 15 | # ******************************************************************************
## 16 | 
## 17 | set_config &lt;- function() {
## 18 |   # 01_definitions.r
## 19 |   set_definitions()
## 20 | 
## 21 |   # 02_permissions.r
## 22 |   set_permissions()
## 23 | 
## 24 |   # 03_db_schemas.r
## 25 |   set_db_schemas()
## 26 | 
## 27 |   # 04_tasks.r
## 28 |   set_tasks()
## 29 | 
## 30 |   # 05_deliverables.r
## 31 |   set_deliverables()
## 32 | 
## 33 |   # 06_config.r
## 34 |   set_progressr()
## 35 | }
## 36 | 
## 37 | set_progressr &lt;- function() {
## 38 |   progressr::handlers(progressr::handler_progress(
## 39 |     format = "[:bar] :current/:total (:percent) in :elapsedfull, eta: :eta",
## 40 |     clear = FALSE
## 41 |   ))
## 42 | }</code></pre>
</div>
<div id="onload.r" class="section level2" number="3.9">
<h2>
<span class="header-section-number">3.9</span> 07_onLoad.r<a class="anchor" aria-label="anchor" href="#onload.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/07_onLoad.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/07_onLoad.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/07_onLoad.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 07_onLoad.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Initializing everything that happens when the package is loaded.
##  8 | #
##  9 | #   E.g. Calling bash scripts that authenticate against Kerebros, setting the
## 10 | #   configs as defined in 06_config.r.
## 11 | #
## 12 | # ******************************************************************************
## 13 | # ******************************************************************************
## 14 | 
## 15 | .onLoad &lt;- function(libname, pkgname) {
## 16 |   # Mechanism to authenticate as necessary (e.g. Kerebros)
## 17 |   try(system2("/bin/authenticate.sh", stdout = NULL), TRUE)
## 18 | 
## 19 |   # 5_config.r
## 20 |   set_config()
## 21 | 
## 22 |   # https://github.com/rstudio/rmarkdown/issues/1632
## 23 |   assignInNamespace("clean_tmpfiles", clean_tmpfiles_mod, ns = "rmarkdown")
## 24 | 
## 25 |   invisible()
## 26 | }</code></pre>
</div>
<div id="onattach.r" class="section level2" number="3.10">
<h2>
<span class="header-section-number">3.10</span> 08_onAttach.r<a class="anchor" aria-label="anchor" href="#onattach.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/08_onAttach.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/08_onAttach.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/08_onAttach.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 08_onAttach.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   What you want to happen when someone types library(yourpackage)
##  8 | #
##  9 | # ******************************************************************************
## 10 | # ******************************************************************************
## 11 | 
## 12 | .onAttach &lt;- function(libname, pkgname) {
## 13 | 
## 14 | }</code></pre>
</div>
<div id="util_.r" class="section level2" number="3.11">
<h2>
<span class="header-section-number">3.11</span> 99_util_*.r<a class="anchor" aria-label="anchor" href="#util_.r"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/99_util_no_data_plot.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/99_util_no_data_plot.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/99_util_no_data_plot.r
## 
##  1 | # ******************************************************************************
##  2 | # ******************************************************************************
##  3 | #
##  4 | # 99_util_*.r
##  5 | #
##  6 | # PURPOSE 1:
##  7 | #   Utility functions that are used across multiple tasks
##  8 | #
##  9 | # ******************************************************************************
## 10 | # ******************************************************************************
## 11 | 
## 12 | no_data_plot &lt;- function(){
## 13 |   data=data.frame(x=0,y=0)
## 14 |   q &lt;- ggplot(data=data)
## 15 |   q &lt;- q + theme_void()
## 16 |   q &lt;- q + annotate("text", label=glue::glue("Ikke noe data {fhi::nb$aa} vise"), x=0, y=0, size=10)
## 17 |   q
## 18 | }</code></pre>
</div>
<div id="task-files" class="section level2" number="3.12">
<h2>
<span class="header-section-number">3.12</span> Task files<a class="anchor" aria-label="anchor" href="#task-files"><i class="fas fa-link"></i></a>
</h2>
<p>Task files are placed in .r files under their own names.</p>
<div id="weather_download_and_import_rawdata.r" class="section level3" number="3.12.1">
<h3>
<span class="header-section-number">3.12.1</span> weather_download_and_import_rawdata.r<a class="anchor" aria-label="anchor" href="#weather_download_and_import_rawdata.r"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_download_and_import_rawdata.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_download_and_import_rawdata.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_download_and_import_rawdata.r
## 
##   1 | # **** action **** ----
##   2 | #' weather_download_and_import_rawdata (action)
##   3 | #' @param data Data
##   4 | #' @param argset Argset
##   5 | #' @param schema DB Schema
##   6 | #' @export
##   7 | weather_download_and_import_rawdata_action &lt;- function(data, argset, schema) {
##   8 |   # tm_run_task("weather_download_and_import_rawdata")
##   9 | 
##  10 |   if (plnr::is_run_directly()) {
##  11 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
##  12 | 
##  13 |     index_plan &lt;- 1
##  14 |     index_analysis &lt;- 1
##  15 | 
##  16 |     data &lt;- sc::tm_get_data("weather_download_and_import_rawdata", index_plan = index_plan)
##  17 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan, index_analysis = index_analysis)
##  18 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
##  19 |   }
##  20 | 
##  21 |   # special case that runs before everything
##  22 |   if (argset$first_analysis == TRUE) {
##  23 | 
##  24 |   }
##  25 | 
##  26 |   a &lt;- data$data
##  27 | 
##  28 |   baz &lt;- xml2::xml_find_all(a, ".//maxTemperature")
##  29 |   res &lt;- vector("list", length = length(baz))
##  30 |   for (i in seq_along(baz)) {
##  31 |     parent &lt;- xml2::xml_parent(baz[[i]])
##  32 |     grandparent &lt;- xml2::xml_parent(parent)
##  33 |     time_from &lt;- xml2::xml_attr(grandparent, "from")
##  34 |     time_to &lt;- xml2::xml_attr(grandparent, "to")
##  35 |     x &lt;- xml2::xml_find_all(parent, ".//minTemperature")
##  36 |     temp_min &lt;- xml2::xml_attr(x, "value")
##  37 |     x &lt;- xml2::xml_find_all(parent, ".//maxTemperature")
##  38 |     temp_max &lt;- xml2::xml_attr(x, "value")
##  39 |     x &lt;- xml2::xml_find_all(parent, ".//precipitation")
##  40 |     precip &lt;- xml2::xml_attr(x, "value")
##  41 |     res[[i]] &lt;- data.frame(
##  42 |       time_from = as.character(time_from),
##  43 |       time_to = as.character(time_to),
##  44 |       temp_max = as.numeric(temp_max),
##  45 |       temp_min = as.numeric(temp_min),
##  46 |       precip = as.numeric(precip)
##  47 |     )
##  48 |   }
##  49 |   res &lt;- rbindlist(res)
##  50 |   res &lt;- res[stringr::str_sub(time_from, 12, 13) %in% c("00", "06", "12", "18")]
##  51 |   res[, date := as.Date(stringr::str_sub(time_from, 1, 10))]
##  52 |   res[, N := .N, by = date]
##  53 |   res &lt;- res[N == 4]
##  54 |   res &lt;- res[
##  55 |     ,
##  56 |     .(
##  57 |       temp_max = max(temp_max),
##  58 |       temp_min = min(temp_min),
##  59 |       precip = sum(precip)
##  60 |     ),
##  61 |     keyby = .(date)
##  62 |   ]
##  63 | 
##  64 |   # we look at the downloaded data
##  65 |   # res
##  66 | 
##  67 |   # we now need to format it
##  68 |   res[, granularity_time := "day"]
##  69 |   res[, sex := "total"]
##  70 |   res[, age := "total"]
##  71 |   res[, location_code := argset$location_code]
##  72 | 
##  73 |   # fill in missing structural variables
##  74 |   sc::fill_in_missing_v8(res, border = 2020)
##  75 | 
##  76 |   # we look at the downloaded data
##  77 |   # res
##  78 | 
##  79 |   # put data in db table
##  80 |   schema$anon_example_weather_rawdata$insert_data(res)
##  81 | 
##  82 |   # special case that runs after everything
##  83 |   if (argset$last_analysis == TRUE) {
##  84 | 
##  85 |   }
##  86 | }
##  87 | 
##  88 | # **** data_selector **** ----
##  89 | #' weather_download_and_import_rawdata (data selector)
##  90 | #' @param argset Argset
##  91 | #' @param schema DB Schema
##  92 | #' @export
##  93 | weather_download_and_import_rawdata_data_selector &lt;- function(argset, schema) {
##  94 |   if (plnr::is_run_directly()) {
##  95 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
##  96 | 
##  97 |     index_plan &lt;- 1
##  98 | 
##  99 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan)
## 100 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
## 101 |   }
## 102 | 
## 103 |   # find the mid lat/long for the specified location_code
## 104 |   gps &lt;- fhimaps::norway_lau2_map_b2020_default_dt[location_code == argset$location_code,.(
## 105 |     lat = mean(lat),
## 106 |     long = mean(long)
## 107 |   )]
## 108 | 
## 109 |   # download the forecast for the specified location_code
## 110 |   d &lt;- httr::GET(glue::glue("https://api.met.no/weatherapi/locationforecast/2.0/classic?lat={gps$lat}&amp;lon={gps$long}"), httr::content_type_xml())
## 111 |   d &lt;- xml2::read_xml(d$content)
## 112 | 
## 113 |   # The variable returned must be a named list
## 114 |   retval &lt;- list(
## 115 |     "data" = d
## 116 |   )
## 117 | 
## 118 |   retval
## 119 | }
## 120 | 
## 121 | # **** functions **** ----</code></pre>
</div>
<div id="weather_clean_data.r" class="section level3" number="3.12.2">
<h3>
<span class="header-section-number">3.12.2</span> weather_clean_data.r<a class="anchor" aria-label="anchor" href="#weather_clean_data.r"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_clean_data.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_clean_data.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_clean_data.r
## 
##   1 | # **** action **** ----
##   2 | #' weather_clean_data (action)
##   3 | #' @param data Data
##   4 | #' @param argset Argset
##   5 | #' @param schema DB Schema
##   6 | #' @export
##   7 | weather_clean_data_action &lt;- function(data, argset, schema) {
##   8 |   # tm_run_task("weather_clean_data")
##   9 | 
##  10 |   if (plnr::is_run_directly()) {
##  11 |     # sc::tm_get_plans_argsets_as_dt("weather_clean_data")
##  12 | 
##  13 |     index_plan &lt;- 1
##  14 |     index_analysis &lt;- 1
##  15 | 
##  16 |     data &lt;- sc::tm_get_data("weather_clean_data", index_plan = index_plan)
##  17 |     argset &lt;- sc::tm_get_argset("weather_clean_data", index_plan = index_plan, index_analysis = index_analysis)
##  18 |     schema &lt;- sc::tm_get_schema("weather_clean_data")
##  19 |   }
##  20 | 
##  21 |   # special case that runs before everything
##  22 |   if (argset$first_analysis == TRUE) {
##  23 | 
##  24 |   }
##  25 | 
##  26 |   # make sure there's no missing data via the creation of a skeleton
##  27 |   # https://folkehelseinstituttet.github.io/fhidata/articles/Skeletons.html
##  28 | 
##  29 |   # Create a variable (possibly a list) to hold the data
##  30 |   d_agg &lt;- list()
##  31 |   d_agg$day_municip &lt;- copy(data$day_municip)
##  32 | 
##  33 |   # Pull out important dates
##  34 |   date_min &lt;- min(d_agg$day_municip$date, na.rm = T)
##  35 |   date_max &lt;- max(d_agg$day_municip$date, na.rm = T)
##  36 | 
##  37 |   # Create `multiskeleton`
##  38 |   # granularity_geo should have the following groups:
##  39 |   # - nodata (when no data is available, and there is no "finer" data available to aggregate up)
##  40 |   # - all levels of granularity_geo where you have data available
##  41 |   # If you do not have data for a specific granularity_geo, but there is "finer" data available
##  42 |   # then you should not include this granularity_geo in the multiskeleton, because you will create
##  43 |   # it later when you aggregate up your data (baregion)
##  44 |   multiskeleton_day &lt;- fhidata::make_skeleton(
##  45 |     date_min = date_min,
##  46 |     date_max = date_max,
##  47 |     granularity_geo = list(
##  48 |       "nodata" = c(
##  49 |         "wardoslo",
##  50 |         "extrawardoslo",
##  51 |         "missingwardoslo",
##  52 |         "wardbergen",
##  53 |         "missingwardbergen",
##  54 |         "wardstavanger",
##  55 |         "missingwardstavanger",
##  56 |         "notmainlandmunicip",
##  57 |         "missingmunicip",
##  58 |         "notmainlandcounty",
##  59 |         "missingcounty"
##  60 |       ),
##  61 |       "municip" = c(
##  62 |         "municip"
##  63 |       )
##  64 |     )
##  65 |   )
##  66 | 
##  67 |   # Merge in the information you have at different geographical granularities
##  68 |   # one level at a time
##  69 |   # municip
##  70 |   multiskeleton_day$municip[
##  71 |     d_agg$day_municip,
##  72 |     on = c("location_code", "date"),
##  73 |     c(
##  74 |       "temp_max",
##  75 |       "temp_min",
##  76 |       "precip"
##  77 |     ) := .(
##  78 |       temp_max,
##  79 |       temp_min,
##  80 |       precip
##  81 |     )
##  82 |   ]
##  83 | 
##  84 |   multiskeleton_day$municip[]
##  85 | 
##  86 |   # Aggregate up to higher geographical granularities (county)
##  87 |   multiskeleton_day$county &lt;- multiskeleton_day$municip[
##  88 |     fhidata::norway_locations_hierarchy(
##  89 |       from = "municip",
##  90 |       to = "county"
##  91 |     ),
##  92 |     on = c(
##  93 |       "location_code==from_code"
##  94 |     )
##  95 |   ][,
##  96 |     .(
##  97 |       temp_max = mean(temp_max, na.rm = T),
##  98 |       temp_min = mean(temp_min, na.rm = T),
##  99 |       precip = mean(precip, na.rm = T),
## 100 |       granularity_geo = "county"
## 101 |     ),
## 102 |     by = .(
## 103 |       granularity_time,
## 104 |       date,
## 105 |       location_code = to_code
## 106 |     )
## 107 |   ]
## 108 | 
## 109 |   multiskeleton_day$county[]
## 110 | 
## 111 |   # Aggregate up to higher geographical granularities (nation)
## 112 |   multiskeleton_day$nation &lt;- multiskeleton_day$municip[
## 113 |     ,
## 114 |     .(
## 115 |       temp_max = mean(temp_max, na.rm = T),
## 116 |       temp_min = mean(temp_min, na.rm = T),
## 117 |       precip = mean(precip, na.rm = T),
## 118 |       granularity_geo = "nation",
## 119 |       location_code = "norge"
## 120 |     ),
## 121 |     by = .(
## 122 |       granularity_time,
## 123 |       date
## 124 |     )
## 125 |   ]
## 126 | 
## 127 |   multiskeleton_day$nation[]
## 128 | 
## 129 |   # combine all the different granularity_geos
## 130 |   skeleton_day &lt;- rbindlist(multiskeleton_day, fill = TRUE, use.names = TRUE)
## 131 | 
## 132 |   skeleton_day[]
## 133 | 
## 134 |   # 10. (If desirable) aggregate up to higher time granularities
## 135 |   # if necessary, it is now easy to aggregate up to weekly data from here
## 136 |   skeleton_isoweek &lt;- copy(skeleton_day)
## 137 |   skeleton_isoweek[, isoyearweek := fhiplot::isoyearweek_c(date)]
## 138 |   skeleton_isoweek &lt;- skeleton_isoweek[
## 139 |     ,
## 140 |     .(
## 141 |       temp_max = mean(temp_max, na.rm = T),
## 142 |       temp_min = mean(temp_min, na.rm = T),
## 143 |       precip = mean(precip, na.rm = T),
## 144 |       granularity_time = "isoweek"
## 145 |     ),
## 146 |     keyby = .(
## 147 |       isoyearweek,
## 148 |       granularity_geo,
## 149 |       location_code
## 150 |     )
## 151 |   ]
## 152 | 
## 153 |   skeleton_isoweek[]
## 154 | 
## 155 |   # we now need to format it and fill in missing structural variables
## 156 |   # day
## 157 |   skeleton_day[, sex := "total"]
## 158 |   skeleton_day[, age := "total"]
## 159 |   sc::fill_in_missing_v8(skeleton_day, border = config$border)
## 160 | 
## 161 |   # isoweek
## 162 |   skeleton_isoweek[, sex := "total"]
## 163 |   skeleton_isoweek[, age := "total"]
## 164 |   sc::fill_in_missing_v8(skeleton_isoweek, border = config$border)
## 165 |   skeleton_isoweek[, date := as.Date(date)]
## 166 | 
## 167 |   skeleton &lt;- rbindlist(
## 168 |     list(
## 169 |       skeleton_day,
## 170 |       skeleton_isoweek
## 171 |     ),
## 172 |     use.names = T
## 173 |   )
## 174 | 
## 175 |   # put data in db table
## 176 |   schema$anon_example_weather_data$drop_all_rows_and_then_insert_data(skeleton)
## 177 | 
## 178 |   # special case that runs after everything
## 179 |   if (argset$last_analysis == TRUE) {
## 180 | 
## 181 |   }
## 182 | }
## 183 | 
## 184 | # **** data_selector **** ----
## 185 | #' weather_clean_data (data selector)
## 186 | #' @param argset Argset
## 187 | #' @param schema DB Schema
## 188 | #' @export
## 189 | weather_clean_data_data_selector &lt;- function(argset, schema) {
## 190 |   if (plnr::is_run_directly()) {
## 191 |     # sc::tm_get_plans_argsets_as_dt("weather_clean_data")
## 192 | 
## 193 |     index_plan &lt;- 1
## 194 | 
## 195 |     argset &lt;- sc::tm_get_argset("weather_clean_data", index_plan = index_plan)
## 196 |     schema &lt;- sc::tm_get_schema("weather_clean_data")
## 197 |   }
## 198 | 
## 199 |   # The database schemas can be accessed here
## 200 |   d &lt;- schema$anon_example_weather_rawdata$tbl() %&gt;%
## 201 |     sc::mandatory_db_filter(
## 202 |       granularity_time = "day",
## 203 |       granularity_time_not = NULL,
## 204 |       granularity_geo = "municip",
## 205 |       granularity_geo_not = NULL,
## 206 |       country_iso3 = NULL,
## 207 |       location_code = NULL,
## 208 |       age = "total",
## 209 |       age_not = NULL,
## 210 |       sex = "total",
## 211 |       sex_not = NULL
## 212 |     ) %&gt;%
## 213 |     dplyr::select(
## 214 |       granularity_time,
## 215 |       # granularity_geo,
## 216 |       # country_iso3,
## 217 |       location_code,
## 218 |       # border,
## 219 |       # age,
## 220 |       # sex,
## 221 | 
## 222 |       date,
## 223 | 
## 224 |       # isoyear,
## 225 |       # isoweek,
## 226 |       # isoyearweek,
## 227 |       # season,
## 228 |       # seasonweek,
## 229 | 
## 230 |       # calyear,
## 231 |       # calmonth,
## 232 |       # calyearmonth,
## 233 | 
## 234 |       temp_max,
## 235 |       temp_min,
## 236 |       precip
## 237 |     ) %&gt;%
## 238 |     dplyr::collect() %&gt;%
## 239 |     as.data.table() %&gt;%
## 240 |     setorder(
## 241 |       location_code,
## 242 |       date
## 243 |     )
## 244 | 
## 245 |   # The variable returned must be a named list
## 246 |   retval &lt;- list(
## 247 |     "day_municip" = d
## 248 |   )
## 249 | 
## 250 |   retval
## 251 | }
## 252 | 
## 253 | # **** functions **** ----</code></pre>
</div>
<div id="weather_export_weather_plots.r" class="section level3" number="3.12.3">
<h3>
<span class="header-section-number">3.12.3</span> weather_export_weather_plots.r<a class="anchor" aria-label="anchor" href="#weather_export_weather_plots.r"><i class="fas fa-link"></i></a>
</h3>
<p><a href="https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_export_plots.r" class="uri">https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_export_plots.r</a></p>
<pre><code>## https://github.com/sykdomspulsen-org/scskeleton/blob/main/R/weather_export_plots.r
## 
##   1 | # **** action **** ----
##   2 | #' weather_export_plots (action)
##   3 | #' @param data Data
##   4 | #' @param argset Argset
##   5 | #' @param schema DB Schema
##   6 | #' @export
##   7 | weather_export_plots_action &lt;- function(data, argset, schema) {
##   8 |   # tm_run_task("weather_export_plots")
##   9 | 
##  10 |   if(plnr::is_run_directly()){
##  11 |     # sc::tm_get_plans_argsets_as_dt("weather_export_plots")
##  12 | 
##  13 |     index_plan &lt;- 1
##  14 |     index_analysis &lt;- 1
##  15 | 
##  16 |     data &lt;- sc::tm_get_data("weather_export_plots", index_plan = index_plan)
##  17 |     argset &lt;- sc::tm_get_argset("weather_export_plots", index_plan = index_plan, index_analysis = index_analysis)
##  18 |     schema &lt;- sc::tm_get_schema("weather_export_plots")
##  19 |   }
##  20 | 
##  21 |   # code goes here
##  22 |   # special case that runs before everything
##  23 |   if(argset$first_analysis == TRUE){
##  24 | 
##  25 |   }
##  26 | 
##  27 |   # create the output_dir (if it doesn't exist)
##  28 |   fs::dir_create(glue::glue(argset$output_dir))
##  29 | 
##  30 |   q &lt;- ggplot(data$data, aes(x = date, ymin = temp_min, ymax = temp_max))
##  31 |   q &lt;- q + geom_ribbon(alpha = 0.5)
##  32 | 
##  33 |   ggsave(
##  34 |     filename = glue::glue(argset$output_absolute_path),
##  35 |     plot = q
##  36 |   )
##  37 | 
##  38 |   # special case that runs after everything
##  39 |   # copy to anon_web?
##  40 |   if(argset$last_analysis == TRUE){
##  41 | 
##  42 |   }
##  43 | }
##  44 | 
##  45 | # **** data_selector **** ----
##  46 | #' weather_export_plots (data selector)
##  47 | #' @param argset Argset
##  48 | #' @param schema DB Schema
##  49 | #' @export
##  50 | weather_export_plots_data_selector = function(argset, schema){
##  51 |   if(plnr::is_run_directly()){
##  52 |     # sc::tm_get_plans_argsets_as_dt("weather_export_plots")
##  53 | 
##  54 |     index_plan &lt;- 1
##  55 | 
##  56 |     argset &lt;- sc::tm_get_argset("weather_export_plots", index_plan = index_plan)
##  57 |     schema &lt;- sc::tm_get_schema("weather_export_plots")
##  58 |   }
##  59 | 
##  60 |   # The database schemas can be accessed here
##  61 |   d &lt;- schema$anon_example_weather_data$tbl() %&gt;%
##  62 |     sc::mandatory_db_filter(
##  63 |       granularity_time = NULL,
##  64 |       granularity_time_not = NULL,
##  65 |       granularity_geo = NULL,
##  66 |       granularity_geo_not = NULL,
##  67 |       country_iso3 = NULL,
##  68 |       location_code = argset$location_code,
##  69 |       age = NULL,
##  70 |       age_not = NULL,
##  71 |       sex = NULL,
##  72 |       sex_not = NULL
##  73 |     ) %&gt;%
##  74 |     dplyr::select(
##  75 |       # granularity_time,
##  76 |       # granularity_geo,
##  77 |       # country_iso3,
##  78 |       # location_code,
##  79 |       # border,
##  80 |       # age,
##  81 |       # sex,
##  82 | 
##  83 |       date,
##  84 | 
##  85 |       # isoyear,
##  86 |       # isoweek,
##  87 |       # isoyearweek,
##  88 |       # season,
##  89 |       # seasonweek,
##  90 |       #
##  91 |       # calyear,
##  92 |       # calmonth,
##  93 |       # calyearmonth,
##  94 | 
##  95 |       temp_max,
##  96 |       temp_min
##  97 |     ) %&gt;%
##  98 |     dplyr::collect() %&gt;%
##  99 |     as.data.table() %&gt;%
## 100 |     setorder(
## 101 |       # location_code,
## 102 |       date
## 103 |     )
## 104 | 
## 105 |   # The variable returned must be a named list
## 106 |   retval &lt;- list(
## 107 |     "data" = d
## 108 |   )
## 109 |   retval
## 110 | }
## 111 | 
## 112 | # **** functions **** ----
## 113 | 
## 114 | 
## 115 | 
## 116 |</code></pre>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tasks.html"><span class="header-section-number">2</span> Tasks</a></div>
<div class="next"><a href="tutorial-1-introduction.html"><span class="header-section-number">4</span> Tutorial 1: Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#file-layout"><span class="header-section-number">3</span> File Layout</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">3.1</span> Introduction</a></li>
<li><a class="nav-link" href="#env_and_namespace.r"><span class="header-section-number">3.2</span> 00_env_and_namespace.r</a></li>
<li><a class="nav-link" href="#definitions.r"><span class="header-section-number">3.3</span> 01_definitions.r</a></li>
<li><a class="nav-link" href="#permissions.r"><span class="header-section-number">3.4</span> 02_permissions.r</a></li>
<li><a class="nav-link" href="#db_schemas.r"><span class="header-section-number">3.5</span> 03_db_schemas.r</a></li>
<li><a class="nav-link" href="#tasks.r"><span class="header-section-number">3.6</span> 04_tasks.r</a></li>
<li><a class="nav-link" href="#deliverables.r"><span class="header-section-number">3.7</span> 05_deliverables.r</a></li>
<li><a class="nav-link" href="#config.r"><span class="header-section-number">3.8</span> 06_config.r</a></li>
<li><a class="nav-link" href="#onload.r"><span class="header-section-number">3.9</span> 07_onLoad.r</a></li>
<li><a class="nav-link" href="#onattach.r"><span class="header-section-number">3.10</span> 08_onAttach.r</a></li>
<li><a class="nav-link" href="#util_.r"><span class="header-section-number">3.11</span> 99_util_*.r</a></li>
<li>
<a class="nav-link" href="#task-files"><span class="header-section-number">3.12</span> Task files</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#weather_download_and_import_rawdata.r"><span class="header-section-number">3.12.1</span> weather_download_and_import_rawdata.r</a></li>
<li><a class="nav-link" href="#weather_clean_data.r"><span class="header-section-number">3.12.2</span> weather_clean_data.r</a></li>
<li><a class="nav-link" href="#weather_export_weather_plots.r"><span class="header-section-number">3.12.3</span> weather_export_weather_plots.r</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Sykdomspulsen Core in Depth</strong>" was written by members of the Sykdomspulsen Team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
