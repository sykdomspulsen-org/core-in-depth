<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4 Tutorial 1: Introduction | Sykdomspulsen Core in Depth</title>
<meta name="author" content="members of the Sykdomspulsen Team">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="4 Tutorial 1: Introduction | Sykdomspulsen Core in Depth">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4 Tutorial 1: Introduction | Sykdomspulsen Core in Depth">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><meta name="description" content="4.1 Setup Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
<meta property="og:description" content="4.1 Setup Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
<meta name="twitter:description" content="4.1 Setup Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="https://docs.sykdomspulsen.no" title="">docs.sykdomspulsen.no</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Sykdomspulsen Core in Depth</a></li>
<li><a class="" href="authors.html">Authors</a></li>
<li><a class="" href="db-schemas.html"><span class="header-section-number">1</span> DB Schemas</a></li>
<li><a class="" href="tasks.html"><span class="header-section-number">2</span> Tasks</a></li>
<li><a class="" href="file-layout.html"><span class="header-section-number">3</span> File Layout</a></li>
<li><a class="active" href="tutorial-1-introduction.html"><span class="header-section-number">4</span> Tutorial 1: Introduction</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="tutorial-1-introduction" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Tutorial 1: Introduction<a class="anchor" aria-label="anchor" href="#tutorial-1-introduction"><i class="fas fa-link"></i></a>
</h1>
<div id="setup" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Setup<a class="anchor" aria-label="anchor" href="#setup"><i class="fas fa-link"></i></a>
</h2>
<p>Implementing Sykdomspulsen Core requires a number of functions to be called in the correct order. To make this as simple as possible, we have provided a skeleton implementation at <a href="https://github.com/sykdomspulsen-org/scskeleton">sykdomspulsen-org/scskeleton</a></p>
<p>For this tutorial you should clone <a href="https://github.com/sykdomspulsen-org/sc-tutorial-start">GitHub repo</a> to your server. This will be the package that you will be working on throughout this tutorial. You may choose to do a global find/replace on <code>sc-tutorial-start</code> with the name you want for your R package. We will refer to this R package as your “sc implementation”.</p>
<p>You can also clone <a href="https://github.com/sykdomspulsen-org/sc-tutorial-end">sykdomspulsen-org/sc-tutorial-end</a> to your server. This is the end product of the tutorial, and you should refer to it in order to check your work.</p>
<p>For the purposes of this tutorial, we assume that the reader is either using RStudio Server Open Source or RStudio Workbench inside Docker containers that have been built according to the Sykdomspulsen specifications. We will refer to your implementation of RStudio Server Open Source/RStudio Workbench with the generic term “RStudio”.</p>
</div>
<div id="load-the-code" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Load the code<a class="anchor" aria-label="anchor" href="#load-the-code"><i class="fas fa-link"></i></a>
</h2>
<p>Open<code>sc-tutorial-start</code> in <a href="https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects">RStudio project mode</a>. Restart the R session via <code>Ctrl+Shift+F10</code>, <code><a href="https://rdrr.io/pkg/rstudioapi/man/restartSession.html">rstudioapi::restartSession()</a></code>, or <code>Session &gt; Restart R</code>. This will ensure that you have a clean working environment before you begin. You may now load your sc implementation. This can be done via <code>Ctrl+Shift+L</code>, <code>devtools::load_all(".")</code>, or <code>Build &gt; Load All</code>.</p>
<aside>
In general, we recommend cleaning your working environment every time before running <code>devtools::load_all(".")</code>.
</aside><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rstudioapi</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rstudioapi/man/restartSession.html">restartSession</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html">load_all</a></span><span class="op">(</span><span class="st">"."</span><span class="op">)</span></code></pre></div>
<p>It you are wokring in the sykdomspulsen infrastructure you might see a warning message on the form: sh: <code>1: /bin/authenticate.sh: not found</code>. This has to do with authentication beeing done automatically on sign in. You do not have to worry about this for the purpose of this tutorial. You might also see a warnign starting with “Objects listed as exports, but not present in namespace:”. This can also be ignored.</p>
<p>You can now see which schemas have been loaded by running <code><a href="https://rdrr.io/pkg/sc/man/tm_get_schema_names.html">sc::tm_get_schema_names()</a></code>. These schemas were included in the skeleton. Note that schemas beginning with <code>config_*</code> are special schemas that are automatically generated by <code>sc</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sc/man/tm_get_schema_names.html">tm_get_schema_names</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] "config_last_updated"                                           "config_structure_time"                                        </span>
<span class="co">## [3] "rundate"                                                       "config_datetime"                                              </span>
<span class="co">## [5] "anon_example_weather_rawdata"                                  "anon_example_weather_data"                                    </span>
<span class="co">## [7] "anon_example_income"                                           "anon_example_house_prices"                                    </span>
<span class="co">## [9] "anon_example_house_prices_outliers_after_adjusting_for_income"</span></code></pre></div>
<p>When you do this you will not see the schemas related to weather, income, and houseprices and you might see a Warning on the form of “In setup_ns_exports(path, export_all, export_imports) : Objects listed as exports…..”. This is as expected.</p>
<p>You can also see which tasks have been loaded by running <code><a href="https://rdrr.io/pkg/sc/man/tm_get_task_names.html">sc::tm_get_task_names()</a></code>. These tasks were included in the skeleton. We have not yet made any tasks, hence you will see NULL.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sc/man/tm_get_task_names.html">tm_get_task_names</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] "weather_download_and_import_rawdata"                            "weather_clean_data"                                            </span>
<span class="co">## [3] "weather_export_plots"                                           "household_incomes_and_house_prices_import_data"                </span>
<span class="co">## [5] "household_incomes_and_house_prices_fit_model_and_find_outliers" "household_incomes_and_house_prices_plot"</span></code></pre></div>
<!-- ## Running -->
<!-- You can now run these tasks in your console if you want. Note that we use `scskeleton::tm_run_task` instead of `sc::tm_run_task`. This is because we want to ensure that `scexample::.onLoad` has been called which authenticates you. -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- scskeleton::tm_run_task("weather_download_and_import_rawdata") -->
<!-- scskeleton::tm_run_task("weather_clean_data") -->
<!-- scskeleton::tm_run_task("weather_export_weather_plots") -->
<!-- ``` -->
<!-- The rest of the tutorial will walk you through how to create these three tasks. -->
</div>
<div id="weather-data-example" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Weather data example<a class="anchor" aria-label="anchor" href="#weather-data-example"><i class="fas fa-link"></i></a>
</h2>
<p>We are now going to create a weather data example. Our end goal is to plot the minimum and maximal temperature of all counties in Norway. This involves a task for downloading and importing raw data. For this we need to specify a schema which describes the data we want to store, which data identifies unique rows and who has access to the data. We also need to define the task through a task definition, i.e., task name, how many cores we want to use, the structure of the task, common arguments etc. Finally we actually implement the task by writing a data selector function, an action function and sometimes a more detailed function describing the plans and analyses of the task.</p>
<p>We also create a task for cleaning the raw data, again with a schema, a task definition and an implementation of a data selector function and an action function.</p>
<p>Finally we create a task for the creation of the plots.</p>
<p>All the schemas are spesified in <code>03_db_schemas.r</code>, all the task definitions are specified in <code>04_tasks.r</code>. The data selector functions and the action functions corresponding to each task have there own respective script with the name specified in the task description.</p>
</div>
<div id="developing-weather_download_and_import_rawdata" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Developing weather_download_and_import_rawdata<a class="anchor" aria-label="anchor" href="#developing-weather_download_and_import_rawdata"><i class="fas fa-link"></i></a>
</h2>
<p>We will walk you through the development of a task that downloads weather data from an API and imports the raw data into a database table.</p>
<div id="schemas" class="section level3" number="4.4.1">
<h3>
<span class="header-section-number">4.4.1</span> 1. Schemas<a class="anchor" aria-label="anchor" href="#schemas"><i class="fas fa-link"></i></a>
</h3>
<p>The first step when developing any task is specifying the schemas that will be used.</p>
<p>It is strongly recommended that you use the RStudio <code>Addins</code> menu to help you quickly insert code templates.</p>
<div class="inline-figure"><img src="rmd/db-schemas/addins.png" width="100%"></div>
<p>If you go into the script <code>03_db_schemas.r</code> you can see a function called <code>set_db_schemas</code>. All schemas are placed within this function. If you scroll down you can see that there is already a schema called <code>anon_example_weather_rawdata</code> which is commented out.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L18-L64
## 
## 18 |   ## &gt; anon_example_weather_rawdata ----
## 19 |   sc::add_schema_v8(
## 20 |     name_access = c("anon"),
## 21 |     name_grouping = "example_weather",
## 22 |     name_variant = "rawdata",
## 23 |     db_configs = sc::config$db_configs,
## 24 |     field_types =  c(
## 25 |       "granularity_time" = "TEXT",
## 26 |       "granularity_geo" = "TEXT",
## 27 |       "country_iso3" = "TEXT",
## 28 |       "location_code" = "TEXT",
## 29 |       "border" = "INTEGER",
## 30 |       "age" = "TEXT",
## 31 |       "sex" = "TEXT",
## 32 | 
## 33 |       "date" = "DATE",
## 34 | 
## 35 |       "isoyear" = "INTEGER",
## 36 |       "isoweek" = "INTEGER",
## 37 |       "isoyearweek" = "TEXT",
## 38 |       "season" = "TEXT",
## 39 |       "seasonweek" = "DOUBLE",
## 40 | 
## 41 |       "calyear" = "INTEGER",
## 42 |       "calmonth" = "INTEGER",
## 43 |       "calyearmonth" = "TEXT",
## 44 | 
## 45 |       "temp_max" = "DOUBLE",
## 46 |       "temp_min" = "DOUBLE",
## 47 |       "precip" = "DOUBLE"
## 48 |     ),
## 49 |     keys = c(
## 50 |       "granularity_time",
## 51 |       "location_code",
## 52 |       "date",
## 53 |       "age",
## 54 |       "sex"
## 55 |     ),
## 56 |     censors = list(
## 57 |       anon = list(
## 58 | 
## 59 |       )
## 60 |     ),
## 61 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
## 62 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
## 63 |     info = "This db table is used for..."
## 64 |   )</code></pre>
<p>We are now going to recreate this schema.
Make sure your pointer is inside of the curly brackets. Go to the <code>Addins</code> menu and click <code>Insert db schema (anon)</code>. You have now created a boiler plate for your schema.</p>
<div id="schema-name" class="section level4" number="4.4.1.1">
<h4>
<span class="header-section-number">4.4.1.1</span> Schema name<a class="anchor" aria-label="anchor" href="#schema-name"><i class="fas fa-link"></i></a>
</h4>
<p>Start by replacing <code>GROUPING_VARIANT</code> in <code>anon_GROUPING_VARIANT</code> with the name of your schema. For example <code>example_weather_rawdata</code>. The grouping will now be <code>example_weather</code> and the variant is <code>rawdata</code>.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L20-L22
## 
## 20 |     name_access = c("anon"),
## 21 |     name_grouping = "example_weather",
## 22 |     name_variant = "rawdata",</code></pre>
<p>Fill this inn for <code>name_grouping</code> and <code>name_variant</code>. The name of the schema is then <code>anon_example_weather_rawdata</code>.</p>
<p>In the example we define the name of the schema to be <code>anon_example_weather_weather_rawdata</code>.</p>
</div>
<div id="validators" class="section level4" number="4.4.1.2">
<h4>
<span class="header-section-number">4.4.1.2</span> Validators<a class="anchor" aria-label="anchor" href="#validators"><i class="fas fa-link"></i></a>
</h4>
<p>The validators are pre-made and you do not have to change anything.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L61-L63
## 
## 61 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
## 62 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
## 63 |     info = "This db table is used for..."</code></pre>
<p>These are validators that check:</p>
<ul>
<li>Are the column names/field types in the schema definition in line with style guidelines?</li>
<li>Are the values/field contents of the datasets that will be uploaded to the database correct? E.g. Does a date column actually contain dates?</li>
</ul>
<p>When using <code>validator_field_types = sc::validator_field_types_sykdomspulsen</code> we expect that the first 16 columns are always as follows (i.e. standardized structural data):</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L25-L43
## 
## 25 |       "granularity_time" = "TEXT",
## 26 |       "granularity_geo" = "TEXT",
## 27 |       "country_iso3" = "TEXT",
## 28 |       "location_code" = "TEXT",
## 29 |       "border" = "INTEGER",
## 30 |       "age" = "TEXT",
## 31 |       "sex" = "TEXT",
## 32 | 
## 33 |       "date" = "DATE",
## 34 | 
## 35 |       "isoyear" = "INTEGER",
## 36 |       "isoweek" = "INTEGER",
## 37 |       "isoyearweek" = "TEXT",
## 38 |       "season" = "TEXT",
## 39 |       "seasonweek" = "DOUBLE",
## 40 | 
## 41 |       "calyear" = "INTEGER",
## 42 |       "calmonth" = "INTEGER",
## 43 |       "calyearmonth" = "TEXT",</code></pre>
<p>The field <code>info</code> should contain a short description of the data table.</p>
</div>
<div id="field-typescolumn-names" class="section level4" number="4.4.1.3">
<h4>
<span class="header-section-number">4.4.1.3</span> Field types/column names<a class="anchor" aria-label="anchor" href="#field-typescolumn-names"><i class="fas fa-link"></i></a>
</h4>
<p>Add the spesific column names and types needed. In our case we want to store the maximum and minimum temperature and the precipitation. Call them “temp_max”, “temp_min”, and “precip”. These are all “DOUBLE”. Remove <code>"XXXX_n" = "INTEGER"</code>, and <code>"XXXX_pr" = "DOUBLE"</code>as these are dummy variables.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L45-L47
## 
## 45 |       "temp_max" = "DOUBLE",
## 46 |       "temp_min" = "DOUBLE",
## 47 |       "precip" = "DOUBLE"</code></pre>
<p>These are the extra columns that contain the context-specific data in this dataset.</p>
</div>
<div id="keys-1" class="section level4" number="4.4.1.4">
<h4>
<span class="header-section-number">4.4.1.4</span> Keys<a class="anchor" aria-label="anchor" href="#keys-1"><i class="fas fa-link"></i></a>
</h4>
<p>The combination of these columns represents a unique row in the dataset. In this dataset the combination of “granularity_geo”, “location_code”, “date”, “age”, “sex” which are the initial suggestions are sufficient.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L49-L55
## 
## 49 |     keys = c(
## 50 |       "granularity_time",
## 51 |       "location_code",
## 52 |       "date",
## 53 |       "age",
## 54 |       "sex"
## 55 |     ),</code></pre>
</div>
<div id="censoring" class="section level4" number="4.4.1.5">
<h4>
<span class="header-section-number">4.4.1.5</span> Censoring<a class="anchor" aria-label="anchor" href="#censoring"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L56-L60
## 
## 56 |     censors = list(
## 57 |       anon = list(
## 58 | 
## 59 |       )
## 60 |     ),</code></pre>
<p>Censoring that is applied to the datasets. In this example we do not apply censoring hence remove the boiler plate suggestions.</p>
</div>
</div>
<div id="task-definition-task_from_config" class="section level3" number="4.4.2">
<h3>
<span class="header-section-number">4.4.2</span> 2. Task definition (task_from_config)<a class="anchor" aria-label="anchor" href="#task-definition-task_from_config"><i class="fas fa-link"></i></a>
</h3>
<p>Now we have a schema. The second step is defining the task.</p>
<p>Again it is strongly recommended that you use the RStudio <code>Addins</code> menu to help you quickly insert code templates.</p>
<p>Go to script <code>04_tasks.r</code> and place your curser inside of the curly bracket. Use the addins menu and click <code>Insert task_from_config</code>.</p>
<div class="inline-figure"><img src="rmd/tasks/addins_2.png" width="100%"></div>
<p>Now you have a boilerplate for a task definition.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L21-L43
## 
## 21 |   sc::add_task_from_config_v8(
## 22 |     name_grouping = "weather",
## 23 |     name_action = "download_and_import_rawdata",
## 24 |     name_variant = NULL,
## 25 |     cores = 1,
## 26 |     plan_analysis_fn_name = NULL,
## 27 |     for_each_plan = plnr::expand_list(
## 28 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("municip")]$location_code
## 29 |     ),
## 30 |     for_each_analysis = NULL,
## 31 |     universal_argset = NULL,
## 32 |     upsert_at_end_of_each_plan = FALSE,
## 33 |     insert_at_end_of_each_plan = FALSE,
## 34 |     action_fn_name = "scexample::weather_download_and_import_rawdata_action",
## 35 |     data_selector_fn_name = "scexample::weather_download_and_import_rawdata_data_selector",
## 36 |     schema = list(
## 37 |       # input
## 38 | 
## 39 |       # output
## 40 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata
## 41 |     ),
## 42 |     info = "This task downloads and imports the raw weather data from MET's API at the municipal level"
## 43 |   )</code></pre>
<div id="task-name" class="section level4" number="4.4.2.1">
<h4>
<span class="header-section-number">4.4.2.1</span> Task name<a class="anchor" aria-label="anchor" href="#task-name"><i class="fas fa-link"></i></a>
</h4>
<p>Replace <code>TASK_NAME</code> by your task name. For example <code>weather_download_and_import_rawdata</code>. <code>weather</code> is the task/grouping and <code>download_and_import_rawdata</code>is the action name. Insert these for <code>name_grouping</code>, and <code>name_action</code>. For <code>name_variant</code> use <code>NULL</code>.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L22-L24
## 
## 22 |     name_grouping = "weather",
## 23 |     name_action = "download_and_import_rawdata",
## 24 |     name_variant = NULL,</code></pre>
<p>Now the name of the task is defined to be <code>weather_download_and_import_rawdata</code>.</p>
</div>
<div id="cpu-cores" class="section level4" number="4.4.2.2">
<h4>
<span class="header-section-number">4.4.2.2</span> CPU cores<a class="anchor" aria-label="anchor" href="#cpu-cores"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L25-L25
## 
## 25 |     cores = 1,</code></pre>
<p>We specify that the plans will run sequentially with 1 CPU core. If the number of CPU cores is 2 or higher then the first and last plans will run sequentially, and all the plans in the middle will run in parallel. The first and last plans always run sequentially because this allows us to write “special” code for the first and last plans (i.e. “do this before everything runs” and “do this after everything runs”).</p>
</div>
<div id="plananalysis-structure" class="section level4" number="4.4.2.3">
<h4>
<span class="header-section-number">4.4.2.3</span> Plan/analysis structure<a class="anchor" aria-label="anchor" href="#plananalysis-structure"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L26-L30
## 
## 26 |     plan_analysis_fn_name = NULL,
## 27 |     for_each_plan = plnr::expand_list(
## 28 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("municip")]$location_code
## 29 |     ),
## 30 |     for_each_analysis = NULL,</code></pre>
<p>We specify the plan/analysis structure here. You may use one of the following combinations:</p>
<ul>
<li>
<code>plan_analysis_fn_name</code> (rarely used)</li>
<li>
<code>for_each_plan</code> (plan-heavy, one analysis per plan)</li>
<li>
<code>for_each_plan</code> + <code>for_each_analysis</code> (typically analysis-heavy)</li>
</ul>
<p><code>plan_analysis_fn_name</code> is a (rarely used) function that will provide a list containing the plan/analysis structure. It is generally only used when the plan/analysis structure needs to be reactive depending upon some external data (e.g. “an unknown number of data files are provided each day and need to be cleaned”).</p>
<p><code>for_each_plan</code> is a list, with each element corresponding to a plan defined by a named list. Within this named list, each of the named elements will be translated into argset elements that are available for the respective plans. This particular <code>for_each_plan</code> defines a task with 356 plans (one for each municipality).</p>
<p><code>for_each_analysis</code> is nearly the same as <code>for_each_plan</code>. It specifies what kind of analyses you would like to perform within each plan. It is a named list, with each element corresponding to an analysis defined by a named list. Within this named list, each of the named elements will be translated into argset elements that are available for the respective analyses.</p>
<p>An example of a <code>for_each_plan</code> that would correspond to 11 tasks (one for each county):</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">150</span><span class="op">)</span>
<span class="va">for_each_plan</span> <span class="op">=</span> <span class="fu">plnr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plnr/man/expand_list.html">expand_list</a></span><span class="op">(</span>
  location_code <span class="op">=</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_names.html">norway_locations_names</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="va">granularity_geo</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"county"</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">location_code</span>
<span class="op">)</span>
<span class="va">for_each_plan</span>
<span class="co">## [[1]]</span>
<span class="co">## [[1]]$location_code</span>
<span class="co">## [1] "county42"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[2]]</span>
<span class="co">## [[2]]$location_code</span>
<span class="co">## [1] "county34"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[3]]</span>
<span class="co">## [[3]]$location_code</span>
<span class="co">## [1] "county15"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[4]]</span>
<span class="co">## [[4]]$location_code</span>
<span class="co">## [1] "county18"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[5]]</span>
<span class="co">## [[5]]$location_code</span>
<span class="co">## [1] "county03"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[6]]</span>
<span class="co">## [[6]]$location_code</span>
<span class="co">## [1] "county11"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[7]]</span>
<span class="co">## [[7]]$location_code</span>
<span class="co">## [1] "county54"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[8]]</span>
<span class="co">## [[8]]$location_code</span>
<span class="co">## [1] "county50"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[9]]</span>
<span class="co">## [[9]]$location_code</span>
<span class="co">## [1] "county38"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[10]]</span>
<span class="co">## [[10]]$location_code</span>
<span class="co">## [1] "county46"</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## [[11]]</span>
<span class="co">## [[11]]$location_code</span>
<span class="co">## [1] "county30"</span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_names.html">fhidata::norway_locations_names()</a></code> gives us location codes in Norway (try and run if in your console). Implement a plan in your task which has the location codes off all municipalities (municip) in Norway.</p>
</div>
</div>
<div id="universal-argset" class="section level3" number="4.4.3">
<h3>
<span class="header-section-number">4.4.3</span> Universal argset<a class="anchor" aria-label="anchor" href="#universal-argset"><i class="fas fa-link"></i></a>
</h3>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L31-L31
## 
## 31 |     universal_argset = NULL,</code></pre>
<p>Here we can specify a named list, where each of the named elements will be translated into argset elements that are available for all plans/analyses.</p>
<div id="upsertinsert-at-end-of-each-plan" class="section level4" number="4.4.3.1">
<h4>
<span class="header-section-number">4.4.3.1</span> Upsert/insert at end of each plan<a class="anchor" aria-label="anchor" href="#upsertinsert-at-end-of-each-plan"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L32-L33
## 
## 32 |     upsert_at_end_of_each_plan = FALSE,
## 33 |     insert_at_end_of_each_plan = FALSE,</code></pre>
<p>If you include a schema called <code>output</code>, then these options will let you upsert/insert the returned value from <code>action_fn_name</code> at the end of each plan. This is an important nuance, because when you write/develop your task, you can (typically) only write one function (<code>action_fn_name</code>) that is applied to all analyses. This means that if your <code>action_fn</code> wants to upsert/insert data to a schema, it (typically) will do this within <em>every</em> analysis. If you have an analysis-heavy task, then this will be a lot of frequent traffic to the databases, which may affect performance. By using these flags, you can restrict the upsert/insert to the end of the plan, which may increase performance.</p>
</div>
<div id="action_fn_name-1" class="section level4" number="4.4.3.2">
<h4>
<span class="header-section-number">4.4.3.2</span> action_fn_name<a class="anchor" aria-label="anchor" href="#action_fn_name-1"><i class="fas fa-link"></i></a>
</h4>
<p>The action_fn_name specifies the name of the function that corresponds to the action. That is, the function that is called in every analysis. Note that:</p>
<ul>
<li>This is a string</li>
<li>It must include the package name</li>
<li>It is typically of the form <code>PACKAGE::TASK_action</code>
</li>
</ul>
<p>In our case the package is <code>scskeleton</code> and the TASK is <code>weather_download_and_import_rawdata</code>. Insert this in your task.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L34-L34
## 
## 34 |     action_fn_name = "scexample::weather_download_and_import_rawdata_action",</code></pre>
</div>
<div id="data_selector_fn_name-1" class="section level4" number="4.4.3.3">
<h4>
<span class="header-section-number">4.4.3.3</span> data_selector_fn_name<a class="anchor" aria-label="anchor" href="#data_selector_fn_name-1"><i class="fas fa-link"></i></a>
</h4>
<p>The data_selecotr_fn_name specifies the name of the function that corresponds to the data selector. That is, the function that is called at the start of every plan to provide data to all of the analyses inside the plan. Note that:</p>
<ul>
<li>This is a string</li>
<li>It must include the package name</li>
<li>It is typically of the form <code>PACKAGE::TASK_data_selector</code>
</li>
</ul>
<p>Try and guess what this would be in our example.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L35-L35
## 
## 35 |     data_selector_fn_name = "scexample::weather_download_and_import_rawdata_data_selector",</code></pre>
</div>
<div id="schemas-1" class="section level4" number="4.4.3.4">
<h4>
<span class="header-section-number">4.4.3.4</span> Schemas<a class="anchor" aria-label="anchor" href="#schemas-1"><i class="fas fa-link"></i></a>
</h4>
<p>The schemas specify a named list, where each element consists of a schema. The names will be passed through as <code>schema$name</code> in <code>action_fn_name</code> and <code>data_selector_fn_name</code>. We must include both the schemas where we get data from and the schemas we store data to.</p>
<p>In our example we do not yet have data so we only specify the schema we have earlier which we called <code>anon_example_weather_rawdata</code>. This meand you can remove the boiler plate input schema and replace <code>SCHEMA_NAME_2</code> with <code>anon_example_weather_rawdata</code>.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L36-L41
## 
## 36 |     schema = list(
## 37 |       # input
## 38 | 
## 39 |       # output
## 40 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata
## 41 |     ),</code></pre>
</div>
<div id="task-description" class="section level4" number="4.4.3.5">
<h4>
<span class="header-section-number">4.4.3.5</span> Task description<a class="anchor" aria-label="anchor" href="#task-description"><i class="fas fa-link"></i></a>
</h4>
<p>Finally create a small task description.</p>
</div>
</div>
<div id="data_selector_fn-1" class="section level3" number="4.4.4">
<h3>
<span class="header-section-number">4.4.4</span> 3. data_selector_fn<a class="anchor" aria-label="anchor" href="#data_selector_fn-1"><i class="fas fa-link"></i></a>
</h3>
<p>The third step in creating a task is defining a data selector function. This is the function that will perform the “one data-pull per plan” and subsequently provide the data to the action.</p>
<p>Go to script <code>weather_download_and_import_rawdata.r</code>.</p>
<p>Use the RStudio <code>Addins</code> menu to help you quickly insert code templates by clicking <code>Insert action and data selector</code>.</p>
<div class="inline-figure"><img src="rmd/tasks/addins_3.png" width="100%"></div>
<p>Just like that, a pre-made boilerplate is ready to go! Find the data_selector part of the script and replace <code>TASK_NAME</code> with our task name <code>weather_download_and_import_rawdata</code>.</p>
<div id="plnris_run_directly" class="section level4" number="4.4.4.1">
<h4>
<span class="header-section-number">4.4.4.1</span> plnr::is_run_directly()<a class="anchor" aria-label="anchor" href="#plnris_run_directly"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L94-L101
## 
##  94 |   if (plnr::is_run_directly()) {
##  95 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
##  96 | 
##  97 |     index_plan &lt;- 1
##  98 | 
##  99 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan)
## 100 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
## 101 |   }</code></pre>
<p>At the top of all <code>data_selector_fn</code>s you will see a section of code wrapped inside <code>if (plnr::is_run_directly()) {</code>. This code will <strong>only</strong> be run if it is manually highlighted inside RStudio and then “run”. This is extremely beneficial to the user, because it means that the user can easily write small pieces of code that are only used during development, which will not be run when the code is run “properly”.</p>
<p>Sykdomspulsen core uses these sections to let the user “jump” directly into the function. Look at the arguments for <code>weather_download_and_import_rawdata_data_selector</code> and you will see that it needs <code>argset</code> and <code>schema</code>.</p>
<p>The code inside <code>if (plnr::is_run_directly()) {</code> loads <code>argset</code> and <code>schema</code> for <code>index_plan = 1</code>. <strong>By running these lines, you can treat the inside of <code>weather_download_and_import_rawdata_data_selector</code> as an interactive script!</strong></p>
<p>This makes the development of the code extremely easy as “everything is an interactive script”.</p>
<p>Check that you have an argset and a schema by running the lines within <code>if (plnr::is_run_directly()) {}</code>.</p>
</div>
</div>
<div id="getting-data" class="section level3" number="4.4.5">
<h3>
<span class="header-section-number">4.4.5</span> Getting data<a class="anchor" aria-label="anchor" href="#getting-data"><i class="fas fa-link"></i></a>
</h3>
<p>The majority of the <code>data_selector_fn</code> is concerned with selecting data (obviously). Remember that the data should be selected to meet the needs of the plan. If you have 11 plans (one for each county), then your <code>data_selector_fn</code> should only extract data for the county of interest.</p>
<p>Take a look at your argset for plan = 1.
Since we do not have input data from a schema we can remove the premade schema. Instead we are going to get data from <code><a href="https://folkehelseinstituttet.github.io/fhimaps/reference/norway_lau2_map_b2020_default_dt.html">fhimaps::norway_lau2_map_b2020_default_dt</a></code> which provides latitudes (lat) and longitudes (long). Explore the available data by running <code><a href="https://folkehelseinstituttet.github.io/fhimaps/reference/norway_lau2_map_b2020_default_dt.html">fhimaps::norway_lau2_map_b2020_default_dt</a></code> in your console. It returns a data table. We only want the mean latitude and longitude of the specific location_code for this particular plan and analysis. Therefor try and select only this data and call it <code>gps</code>.</p>
<p>Now we download the weather forcast for this specific location from an api by using httr::GET and glue::glue to get the right address.</p>
<p>httr::GET(glue::glue(“<a href="https://api.met.no/weatherapi/locationforecast/2.0/classic?lat=%7Bgps%24lat%7D&amp;lon=%7Bgps%24long%7D" class="uri">https://api.met.no/weatherapi/locationforecast/2.0/classic?lat={gps$lat}&amp;lon={gps$long}</a>”), httr::content_type_xml()).
Use xml2::read_xml() to read the content. Take a peak below and implement it yourself.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L103-L111
## 
## 103 |   # find the mid lat/long for the specified location_code
## 104 |   gps &lt;- fhimaps::norway_lau2_map_b2020_default_dt[location_code == argset$location_code,.(
## 105 |     lat = mean(lat),
## 106 |     long = mean(long)
## 107 |   )]
## 108 | 
## 109 |   # download the forecast for the specified location_code
## 110 |   d &lt;- httr::GET(glue::glue("https://api.met.no/weatherapi/locationforecast/2.0/classic?lat={gps$lat}&amp;lon={gps$long}"), httr::content_type_xml())
## 111 |   d &lt;- xml2::read_xml(d$content)</code></pre>
</div>
<div id="returning-data" class="section level3" number="4.4.6">
<h3>
<span class="header-section-number">4.4.6</span> Returning data<a class="anchor" aria-label="anchor" href="#returning-data"><i class="fas fa-link"></i></a>
</h3>
<p><code>data_selector_fn</code> needs to return a named list. This will be made available to the user in <code>action_fn</code> (<code>weather_download_and_import_rawdata_action</code>) via the argument <code>data</code>.</p>
<p>In your task replace “NAME” by the name for your data for example “data”.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L113-L116
## 
## 113 |   # The variable returned must be a named list
## 114 |   retval &lt;- list(
## 115 |     "data" = d
## 116 |   )</code></pre>
<p>The entire data selector function should now look like this.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L88-L119
## 
##  88 | # **** data_selector **** ----
##  89 | #' weather_download_and_import_rawdata (data selector)
##  90 | #' @param argset Argset
##  91 | #' @param schema DB Schema
##  92 | #' @export
##  93 | weather_download_and_import_rawdata_data_selector &lt;- function(argset, schema) {
##  94 |   if (plnr::is_run_directly()) {
##  95 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
##  96 | 
##  97 |     index_plan &lt;- 1
##  98 | 
##  99 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan)
## 100 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
## 101 |   }
## 102 | 
## 103 |   # find the mid lat/long for the specified location_code
## 104 |   gps &lt;- fhimaps::norway_lau2_map_b2020_default_dt[location_code == argset$location_code,.(
## 105 |     lat = mean(lat),
## 106 |     long = mean(long)
## 107 |   )]
## 108 | 
## 109 |   # download the forecast for the specified location_code
## 110 |   d &lt;- httr::GET(glue::glue("https://api.met.no/weatherapi/locationforecast/2.0/classic?lat={gps$lat}&amp;lon={gps$long}"), httr::content_type_xml())
## 111 |   d &lt;- xml2::read_xml(d$content)
## 112 | 
## 113 |   # The variable returned must be a named list
## 114 |   retval &lt;- list(
## 115 |     "data" = d
## 116 |   )
## 117 | 
## 118 |   retval
## 119 | }</code></pre>
<p>Check that the data selector function works by restarting R (<code>ctrl + shift + F10</code>) and loading the packages (<code>ctrl + shift + L</code>) before running through the data selector function line by line.</p>
</div>
<div id="action_fn-1" class="section level3" number="4.4.7">
<h3>
<span class="header-section-number">4.4.7</span> 4. action_fn<a class="anchor" aria-label="anchor" href="#action_fn-1"><i class="fas fa-link"></i></a>
</h3>
<p>The fourth step is defining an action function. This is the function that will perform the “action” within the the analysis. That is, given:</p>
<ul>
<li>data</li>
<li>argset</li>
<li>schema</li>
</ul>
<p>What do you actually want to <em>do</em> with them? Find the action part in your script and replace <code>TASK_NAME</code> with our task name <code>weather_download_and_import_rawdata</code>.</p>
<div id="plnris_run_directly-1" class="section level4" number="4.4.7.1">
<h4>
<span class="header-section-number">4.4.7.1</span> plnr::is_run_directly()<a class="anchor" aria-label="anchor" href="#plnris_run_directly-1"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L95-L102
## 
##  95 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
##  96 | 
##  97 |     index_plan &lt;- 1
##  98 | 
##  99 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan)
## 100 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
## 101 |   }
## 102 |</code></pre>
<p>At the top of all <code>action_fn</code>s you will again see a section of code wrapped inside <code>if (plnr::is_run_directly()) {</code>. This works exactly the same as for the data_selector_fn.</p>
<p>Look at the arguments for <code>weather_download_and_import_rawdata_data_selector</code> and you will see that it needs <code>data</code>, <code>argset</code> and <code>schema</code>. The code inside <code>if (plnr::is_run_directly()) {</code> loads <code>data</code>, <code>argset</code> and <code>schema</code> for <code>index_plan = 1</code> and <code>index_analysis = 1</code>. <strong>By running these lines, you can treat the inside of <code>weather_download_and_import_rawdata_action</code> as an interactive script!</strong></p>
<p>Check out the data, argset and schema you have by running these lines.</p>
</div>
<div id="argsetfirst_analysis" class="section level4" number="4.4.7.2">
<h4>
<span class="header-section-number">4.4.7.2</span> argset$first_analysis<a class="anchor" aria-label="anchor" href="#argsetfirst_analysis"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L21-L24
## 
## 21 |   # special case that runs before everything
## 22 |   if (argset$first_analysis == TRUE) {
## 23 | 
## 24 |   }</code></pre>
<p>This code is only run if it is the first analysis. It is typically used to drop rows in a database, so that the following code may <code>insert</code> data (faster) instead of using <code>upsert</code> data (slower). If you ran the full task at the beginning of this tutorial you can insert <code>schema$anon_example_weather_rawdata$drop_all_rows()</code> inside here to delete the stored data.</p>
</div>
<div id="doing-things" class="section level4" number="4.4.7.3">
<h4>
<span class="header-section-number">4.4.7.3</span> Doing things<a class="anchor" aria-label="anchor" href="#doing-things"><i class="fas fa-link"></i></a>
</h4>
<p>In this tutorial we do not go in to much detail about how the data is collected so for now copy the content of the action function into your action function. (You find it commented out in your file.)</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L26-L80
## 
## 26 |   a &lt;- data$data
## 27 | 
## 28 |   baz &lt;- xml2::xml_find_all(a, ".//maxTemperature")
## 29 |   res &lt;- vector("list", length = length(baz))
## 30 |   for (i in seq_along(baz)) {
## 31 |     parent &lt;- xml2::xml_parent(baz[[i]])
## 32 |     grandparent &lt;- xml2::xml_parent(parent)
## 33 |     time_from &lt;- xml2::xml_attr(grandparent, "from")
## 34 |     time_to &lt;- xml2::xml_attr(grandparent, "to")
## 35 |     x &lt;- xml2::xml_find_all(parent, ".//minTemperature")
## 36 |     temp_min &lt;- xml2::xml_attr(x, "value")
## 37 |     x &lt;- xml2::xml_find_all(parent, ".//maxTemperature")
## 38 |     temp_max &lt;- xml2::xml_attr(x, "value")
## 39 |     x &lt;- xml2::xml_find_all(parent, ".//precipitation")
## 40 |     precip &lt;- xml2::xml_attr(x, "value")
## 41 |     res[[i]] &lt;- data.frame(
## 42 |       time_from = as.character(time_from),
## 43 |       time_to = as.character(time_to),
## 44 |       temp_max = as.numeric(temp_max),
## 45 |       temp_min = as.numeric(temp_min),
## 46 |       precip = as.numeric(precip)
## 47 |     )
## 48 |   }
## 49 |   res &lt;- rbindlist(res)
## 50 |   res &lt;- res[stringr::str_sub(time_from, 12, 13) %in% c("00", "06", "12", "18")]
## 51 |   res[, date := as.Date(stringr::str_sub(time_from, 1, 10))]
## 52 |   res[, N := .N, by = date]
## 53 |   res &lt;- res[N == 4]
## 54 |   res &lt;- res[
## 55 |     ,
## 56 |     .(
## 57 |       temp_max = max(temp_max),
## 58 |       temp_min = min(temp_min),
## 59 |       precip = sum(precip)
## 60 |     ),
## 61 |     keyby = .(date)
## 62 |   ]
## 63 | 
## 64 |   # we look at the downloaded data
## 65 |   # res
## 66 | 
## 67 |   # we now need to format it
## 68 |   res[, granularity_time := "day"]
## 69 |   res[, sex := "total"]
## 70 |   res[, age := "total"]
## 71 |   res[, location_code := argset$location_code]
## 72 | 
## 73 |   # fill in missing structural variables
## 74 |   sc::fill_in_missing_v8(res, border = 2020)
## 75 | 
## 76 |   # we look at the downloaded data
## 77 |   # res
## 78 | 
## 79 |   # put data in db table
## 80 |   schema$anon_example_weather_rawdata$insert_data(res)</code></pre>
<p>Every analysis will perform this code.</p>
<p>Run through it line by line and pay special attention to how the data from the data_selector_fn is accesed, the last part where the data is formatted and we use <code>sc::fill_in_missing_v8(res, border = 2020)</code> to fill inn the mandatory data columns and the end where the data is inserted to the database.</p>
</div>
<div id="accessing-data-from-data_selector_fn" class="section level4" number="4.4.7.4">
<h4>
<span class="header-section-number">4.4.7.4</span> Accessing data from data_selector_fn<a class="anchor" aria-label="anchor" href="#accessing-data-from-data_selector_fn"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L26-L26
## 
## 26 |   a &lt;- data$data</code></pre>
<p>Here you see that we access the data that was passed to us from <code>data_selector_fn</code></p>
</div>
<div id="structural-datascfill_in_missing_v8" class="section level4" number="4.4.7.5">
<h4>
<span class="header-section-number">4.4.7.5</span> Structural data/sc::fill_in_missing_v8<a class="anchor" aria-label="anchor" href="#structural-datascfill_in_missing_v8"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L68-L74
## 
## 68 |   res[, granularity_time := "day"]
## 69 |   res[, sex := "total"]
## 70 |   res[, age := "total"]
## 71 |   res[, location_code := argset$location_code]
## 72 | 
## 73 |   # fill in missing structural variables
## 74 |   sc::fill_in_missing_v8(res, border = 2020)</code></pre>
<p>We have 16 structural data columns that we expect. These columns typically have a lot of redundancy (e.g. date, isoyear, isoyearweek). To make things easier, we provide a function called <code><a href="https://rdrr.io/pkg/sc/man/fill_in_missing_v8.html">sc::fill_in_missing_v8</a></code> that uses the information present in the dataset to try and impute the missing structural data.</p>
</div>
<div id="insertupsert-to-databases" class="section level4" number="4.4.7.6">
<h4>
<span class="header-section-number">4.4.7.6</span> Insert/upsert to databases<a class="anchor" aria-label="anchor" href="#insertupsert-to-databases"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L80-L80
## 
## 80 |   schema$anon_example_weather_rawdata$insert_data(res)</code></pre>
<p>Here we insert the data to the database table.</p>
<p>Insert is an append (so the data cannot already exist in the database table), while upsert is “update (overwrite) if already exists, insert (append) if it doesn’t”.</p>
<p>If you want to deleate the data use <code>schema$NAME_DATABASE$drop_all_rows()</code> in our case <code>schema$anon_example_weather_rawdata$drop_all_rows()</code>.</p>
</div>
<div id="argsetlast_analysis" class="section level4" number="4.4.7.7">
<h4>
<span class="header-section-number">4.4.7.7</span> argset$last_analysis<a class="anchor" aria-label="anchor" href="#argsetlast_analysis"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L21-L24
## 
## 21 |   # special case that runs before everything
## 22 |   if (argset$first_analysis == TRUE) {
## 23 | 
## 24 |   }</code></pre>
<p>This code is only run if it is the last analysis. It is typically used to copy an internal database table (i.e. one that the public is not directly viewing) to an external database (i.e. one that the public is directly viewing).</p>
<p>By distinguishing between internal database tables (e.g. anon_webkhtint_test) and external database tables (e.g. anon_webkht_test) we can do whatever we want to anon_webkhtint_test while anon_webkht_test remains in place and untouched. This makes it less likely that any mistakes will affect any APIs or websites that the public uses.</p>
</div>
</div>
<div id="test-the-code" class="section level3" number="4.4.8">
<h3>
<span class="header-section-number">4.4.8</span> Test the code<a class="anchor" aria-label="anchor" href="#test-the-code"><i class="fas fa-link"></i></a>
</h3>
<p>The action function should look like this.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_download_and_import_rawdata.r#L1-L86
## 
##  1 | # **** action **** ----
##  2 | #' weather_download_and_import_rawdata (action)
##  3 | #' @param data Data
##  4 | #' @param argset Argset
##  5 | #' @param schema DB Schema
##  6 | #' @export
##  7 | weather_download_and_import_rawdata_action &lt;- function(data, argset, schema) {
##  8 |   # tm_run_task("weather_download_and_import_rawdata")
##  9 | 
## 10 |   if (plnr::is_run_directly()) {
## 11 |     # sc::tm_get_plans_argsets_as_dt("weather_download_and_import_rawdata")
## 12 | 
## 13 |     index_plan &lt;- 1
## 14 |     index_analysis &lt;- 1
## 15 | 
## 16 |     data &lt;- sc::tm_get_data("weather_download_and_import_rawdata", index_plan = index_plan)
## 17 |     argset &lt;- sc::tm_get_argset("weather_download_and_import_rawdata", index_plan = index_plan, index_analysis = index_analysis)
## 18 |     schema &lt;- sc::tm_get_schema("weather_download_and_import_rawdata")
## 19 |   }
## 20 | 
## 21 |   # special case that runs before everything
## 22 |   if (argset$first_analysis == TRUE) {
## 23 | 
## 24 |   }
## 25 | 
## 26 |   a &lt;- data$data
## 27 | 
## 28 |   baz &lt;- xml2::xml_find_all(a, ".//maxTemperature")
## 29 |   res &lt;- vector("list", length = length(baz))
## 30 |   for (i in seq_along(baz)) {
## 31 |     parent &lt;- xml2::xml_parent(baz[[i]])
## 32 |     grandparent &lt;- xml2::xml_parent(parent)
## 33 |     time_from &lt;- xml2::xml_attr(grandparent, "from")
## 34 |     time_to &lt;- xml2::xml_attr(grandparent, "to")
## 35 |     x &lt;- xml2::xml_find_all(parent, ".//minTemperature")
## 36 |     temp_min &lt;- xml2::xml_attr(x, "value")
## 37 |     x &lt;- xml2::xml_find_all(parent, ".//maxTemperature")
## 38 |     temp_max &lt;- xml2::xml_attr(x, "value")
## 39 |     x &lt;- xml2::xml_find_all(parent, ".//precipitation")
## 40 |     precip &lt;- xml2::xml_attr(x, "value")
## 41 |     res[[i]] &lt;- data.frame(
## 42 |       time_from = as.character(time_from),
## 43 |       time_to = as.character(time_to),
## 44 |       temp_max = as.numeric(temp_max),
## 45 |       temp_min = as.numeric(temp_min),
## 46 |       precip = as.numeric(precip)
## 47 |     )
## 48 |   }
## 49 |   res &lt;- rbindlist(res)
## 50 |   res &lt;- res[stringr::str_sub(time_from, 12, 13) %in% c("00", "06", "12", "18")]
## 51 |   res[, date := as.Date(stringr::str_sub(time_from, 1, 10))]
## 52 |   res[, N := .N, by = date]
## 53 |   res &lt;- res[N == 4]
## 54 |   res &lt;- res[
## 55 |     ,
## 56 |     .(
## 57 |       temp_max = max(temp_max),
## 58 |       temp_min = min(temp_min),
## 59 |       precip = sum(precip)
## 60 |     ),
## 61 |     keyby = .(date)
## 62 |   ]
## 63 | 
## 64 |   # we look at the downloaded data
## 65 |   # res
## 66 | 
## 67 |   # we now need to format it
## 68 |   res[, granularity_time := "day"]
## 69 |   res[, sex := "total"]
## 70 |   res[, age := "total"]
## 71 |   res[, location_code := argset$location_code]
## 72 | 
## 73 |   # fill in missing structural variables
## 74 |   sc::fill_in_missing_v8(res, border = 2020)
## 75 | 
## 76 |   # we look at the downloaded data
## 77 |   # res
## 78 | 
## 79 |   # put data in db table
## 80 |   schema$anon_example_weather_rawdata$insert_data(res)
## 81 | 
## 82 |   # special case that runs after everything
## 83 |   if (argset$last_analysis == TRUE) {
## 84 | 
## 85 |   }
## 86 | }</code></pre>
<p>Try and restart, load all and run the code line by line.</p>
</div>
<div id="which-plananalysis-is-which" class="section level3" number="4.4.9">
<h3>
<span class="header-section-number">4.4.9</span> Which plan/analysis is which?<a class="anchor" aria-label="anchor" href="#which-plananalysis-is-which"><i class="fas fa-link"></i></a>
</h3>
<p>Inside the <code>if (plnr::is_run_directly()) {</code> sections, you specify <code>index_plan</code> and <code>index_analysis</code>. However, these are just numbers. If you want to specifically look at the plan for Oslo municipality, how do you know which <code>index_plan</code> this corresponds to?</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">150</span><span class="op">)</span>
<span class="fu">sc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sc/man/tm_get_plans_argsets_as_dt.html">tm_get_plans_argsets_as_dt</a></span><span class="op">(</span><span class="st">"weather_download_and_import_rawdata"</span><span class="op">)</span>
<span class="co">##      index_plan index_analysis **universal** **plan** location_code **analysis** **automatic** index      today  yesterday first_analysis</span>
<span class="co">##   1:          1              1             *        *   municip1820            *             *     1 2022-03-01 2022-02-28           TRUE</span>
<span class="co">##   2:          2              1             *        *   municip5403            *             *     2 2022-03-01 2022-02-28          FALSE</span>
<span class="co">##   3:          3              1             *        *   municip3428            *             *     3 2022-03-01 2022-02-28          FALSE</span>
<span class="co">##   4:          4              1             *        *   municip4631            *             *     4 2022-03-01 2022-02-28          FALSE</span>
<span class="co">##   5:          5              1             *        *   municip1871            *             *     5 2022-03-01 2022-02-28          FALSE</span>
<span class="co">##  ---                                                                                                                                     </span>
<span class="co">## 352:        352              1             *        *   municip3442            *             *   352 2022-03-01 2022-02-28          FALSE</span>
<span class="co">## 353:        353              1             *        *   municip3048            *             *   353 2022-03-01 2022-02-28          FALSE</span>
<span class="co">## 354:        354              1             *        *   municip3440            *             *   354 2022-03-01 2022-02-28          FALSE</span>
<span class="co">## 355:        355              1             *        *   municip4626            *             *   355 2022-03-01 2022-02-28          FALSE</span>
<span class="co">## 356:        356              1             *        *   municip3453            *             *   356 2022-03-01 2022-02-28          FALSE</span>
<span class="co">##      first_argset last_analysis last_argset</span>
<span class="co">##   1:         TRUE         FALSE       FALSE</span>
<span class="co">##   2:        FALSE         FALSE       FALSE</span>
<span class="co">##   3:        FALSE         FALSE       FALSE</span>
<span class="co">##   4:        FALSE         FALSE       FALSE</span>
<span class="co">##   5:        FALSE         FALSE       FALSE</span>
<span class="co">##  ---                                       </span>
<span class="co">## 352:        FALSE         FALSE       FALSE</span>
<span class="co">## 353:        FALSE         FALSE       FALSE</span>
<span class="co">## 354:        FALSE         FALSE       FALSE</span>
<span class="co">## 355:        FALSE         FALSE       FALSE</span>
<span class="co">## 356:        FALSE          TRUE        TRUE</span></code></pre></div>
<p>Try and change the plan number and run the script again.</p>
<p>Now you have implemented your first task by creating a schema, a task description a data selector function and an action function! Congratulations!</p>
<p>Run the entire task by running <code>tm_run_task("weather_download_and_import_rawdata")</code>.</p>
</div>
</div>
<div id="developing-weather_clean_data" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Developing weather_clean_data<a class="anchor" aria-label="anchor" href="#developing-weather_clean_data"><i class="fas fa-link"></i></a>
</h2>
<p>The previous task (weather_download_and_import_rawdata) focused on downloading raw data from an API and inserting it into a database table.</p>
<p>The task weather_clean_data focuses on cleaning the raw data and inserting it in another database table. That is, the data source is a Sykdomspulsen Core database table, and the output is also a Sykdomspulsen Core database table.</p>
<p>We will walk you through the development of weather_clean_data, however, the description of this task will be less comprehensive than the previous task, and will focus primarily on parts that are novel.</p>
<p>We already mentioned that weather_clean_data cleans the raw data. We want this task to take the raw data we obtained in the previous task and aggregate it to obtain weather data on different geographical regions than municipalities. To do so we use some pre-made FHI functions such as <code><a href="https://rdrr.io/pkg/fhidata/man/make_skeleton.html">fhidata::make_skeleton</a></code> which makes a data table skeleton for the regions of interest and <code><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_hierarchy.html">fhidata::norway_locations_hierarchy</a></code> which converts location codes from one location code level to another.</p>
<div id="schemas-2" class="section level3" number="4.5.1">
<h3>
<span class="header-section-number">4.5.1</span> 1. Schemas<a class="anchor" aria-label="anchor" href="#schemas-2"><i class="fas fa-link"></i></a>
</h3>
<p>First we start by creating a schema for the data we want this task to store. The structure is exactly the same as for the previous task with name access anon and temp_max, temp_min and precip as additional colums. Try and create this schema in <code>03_db_schemas.r</code>.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L66-L113
## 
##  66 |   ## &gt; anon_example_weather_data ----
##  67 |   sc::add_schema_v8(
##  68 |     name_access = c("anon"),
##  69 |     name_grouping = "example_weather",
##  70 |     name_variant = "data",
##  71 |     db_configs = sc::config$db_configs,
##  72 |     field_types =  c(
##  73 |       "granularity_time" = "TEXT",
##  74 |       "granularity_geo" = "TEXT",
##  75 |       "country_iso3" = "TEXT",
##  76 |       "location_code" = "TEXT",
##  77 |       "border" = "INTEGER",
##  78 |       "age" = "TEXT",
##  79 |       "sex" = "TEXT",
##  80 | 
##  81 |       "date" = "DATE",
##  82 | 
##  83 |       "isoyear" = "INTEGER",
##  84 |       "isoweek" = "INTEGER",
##  85 |       "isoyearweek" = "TEXT",
##  86 |       "season" = "TEXT",
##  87 |       "seasonweek" = "DOUBLE",
##  88 | 
##  89 |       "calyear" = "INTEGER",
##  90 |       "calmonth" = "INTEGER",
##  91 |       "calyearmonth" = "TEXT",
##  92 | 
##  93 |       "temp_max" = "DOUBLE",
##  94 |       "temp_min" = "DOUBLE",
##  95 |       "precip" = "DOUBLE"
##  96 |     ),
##  97 |     keys = c(
##  98 |       "granularity_time",
##  99 |       "location_code",
## 100 |       "date",
## 101 |       "age",
## 102 |       "sex"
## 103 |     ),
## 104 |     censors = list(
## 105 |       anon = list(
## 106 | 
## 107 |       )
## 108 |     ),
## 109 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
## 110 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
## 111 |     info = "This db table is used for..."
## 112 |   )
## 113 |</code></pre>
</div>
<div id="task-definition-task_from_config-1" class="section level3" number="4.5.2">
<h3>
<span class="header-section-number">4.5.2</span> 2. Task definition (task_from_config)<a class="anchor" aria-label="anchor" href="#task-definition-task_from_config-1"><i class="fas fa-link"></i></a>
</h3>
<p>The next step is to define the task in <code>04_tasks.r</code> . For this task the aim is to aggregate data to higher levels meaning we need all data available at the same time and we preform the entire task in one analysis. Hence we need a task with only one plan (x = 1). We need the data from the database created in the previous task as input schema and the schema we just implemented as output schema. Try and create this task definition! (Remember to use the addins menu to get a boiler plate task definition.)</p>
<div id="plananalysis-structure-1" class="section level4" number="4.5.2.1">
<h4>
<span class="header-section-number">4.5.2.1</span> Plan/analysis structure<a class="anchor" aria-label="anchor" href="#plananalysis-structure-1"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L52-L56
## 
## 52 |     plan_analysis_fn_name = NULL,
## 53 |     for_each_plan = plnr::expand_list(
## 54 |       x = 1
## 55 |     ),
## 56 |     for_each_analysis = NULL,</code></pre>
<p>For this particular task, we have decided to only implement one plan containing one analysis, which will process all of the data at once.</p>
<p>If we were only aggregating municipality data to the county level, we could have implemented 11 plans (one for each county). However, because we are also aggregating to the national level, we need all the data available at once.</p>
</div>
<div id="schemas-3" class="section level4" number="4.5.2.2">
<h4>
<span class="header-section-number">4.5.2.2</span> Schemas<a class="anchor" aria-label="anchor" href="#schemas-3"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L62-L68
## 
## 62 |     schema = list(
## 63 |       # input
## 64 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata,
## 65 | 
## 66 |       # output
## 67 |       "anon_example_weather_data" = sc::config$schemas$anon_example_weather_data
## 68 |     ),</code></pre>
<p>We need to specify the schemas that are used for both input and output.</p>
</div>
<div id="full-task-description" class="section level4" number="4.5.2.3">
<h4>
<span class="header-section-number">4.5.2.3</span> Full task description<a class="anchor" aria-label="anchor" href="#full-task-description"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L45-L70
## 
## 45 |   ## &gt; weather_clean_data ----
## 46 |   # tm_run_task("weather_clean_data")
## 47 |   sc::add_task_from_config_v8(
## 48 |     name_grouping = "weather",
## 49 |     name_action = "clean_data",
## 50 |     name_variant = NULL,
## 51 |     cores = 1,
## 52 |     plan_analysis_fn_name = NULL,
## 53 |     for_each_plan = plnr::expand_list(
## 54 |       x = 1
## 55 |     ),
## 56 |     for_each_analysis = NULL,
## 57 |     universal_argset = NULL,
## 58 |     upsert_at_end_of_each_plan = FALSE,
## 59 |     insert_at_end_of_each_plan = FALSE,
## 60 |     action_fn_name = "scexample::weather_clean_data_action",
## 61 |     data_selector_fn_name = "scexample::weather_clean_data_data_selector",
## 62 |     schema = list(
## 63 |       # input
## 64 |       "anon_example_weather_rawdata" = sc::config$schemas$anon_example_weather_rawdata,
## 65 | 
## 66 |       # output
## 67 |       "anon_example_weather_data" = sc::config$schemas$anon_example_weather_data
## 68 |     ),
## 69 |     info = "This task cleans the raw data and aggregates it to county and national level"
## 70 |   )</code></pre>
</div>
</div>
<div id="data_selector_fn-2" class="section level3" number="4.5.3">
<h3>
<span class="header-section-number">4.5.3</span> 3. data_selector_fn<a class="anchor" aria-label="anchor" href="#data_selector_fn-2"><i class="fas fa-link"></i></a>
</h3>
<p>Now we are ready to create the data selector function. Go to script <code>weather_clean_data</code>. Use the addins menu as before to get a boiler plate for the action function and the data selector function and scroll down to the data selector part. Start by inserting your task name instead of <code>TASK_NAME</code>.</p>
<div id="getting-data-specify-the-schema" class="section level4" number="4.5.3.1">
<h4>
<span class="header-section-number">4.5.3.1</span> Getting data (specify the schema)<a class="anchor" aria-label="anchor" href="#getting-data-specify-the-schema"><i class="fas fa-link"></i></a>
</h4>
<p>Next fill inn the name of the input schema instead of <code>SCHEMA_NAME</code>, connecting to the database table linked to the schema.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L200-L200
## 
## 200 |   d &lt;- schema$anon_example_weather_rawdata$tbl() %&gt;%</code></pre>
</div>
<div id="getting-data-scmandatory_db_filter" class="section level4" number="4.5.3.2">
<h4>
<span class="header-section-number">4.5.3.2</span> Getting data (sc::mandatory_db_filter)<a class="anchor" aria-label="anchor" href="#getting-data-scmandatory_db_filter"><i class="fas fa-link"></i></a>
</h4>
<p>We then introduce the sc::mandatory_db_filter. This is a filter on the most common structural variables. We say this is “mandatory” because we want the user to always keep in mind:</p>
<ul>
<li>The minimal amount of data needed to do the job</li>
<li>To be as explicit as possible with what data is needed to do the job</li>
</ul>
<p>Fill inn the mandatory filters as best you can and take a peak below if you are not sure.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L201-L212
## 
## 201 |     sc::mandatory_db_filter(
## 202 |       granularity_time = "day",
## 203 |       granularity_time_not = NULL,
## 204 |       granularity_geo = "municip",
## 205 |       granularity_geo_not = NULL,
## 206 |       country_iso3 = NULL,
## 207 |       location_code = NULL,
## 208 |       age = "total",
## 209 |       age_not = NULL,
## 210 |       sex = "total",
## 211 |       sex_not = NULL
## 212 |     ) %&gt;%</code></pre>
<p>You will notice that we don’t use all of the arguments passed into the function, but we use as many as we can.</p>
</div>
<div id="getting-data-dplyrselect" class="section level4" number="4.5.3.3">
<h4>
<span class="header-section-number">4.5.3.3</span> Getting data (dplyr::select)<a class="anchor" aria-label="anchor" href="#getting-data-dplyrselect"><i class="fas fa-link"></i></a>
</h4>
<p>We always want to be as explicit as possible with what data is needed to do the job. To achieve this, we use <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select</a></code> to select the columns that we are interested in.</p>
<p>If you want to quickly generate a <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select</a></code> boilerplate for your schema that you can copy/paste, you can do this via either of the following:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schema</span><span class="op">$</span><span class="va">anon_example_weather_rawdata</span><span class="op">$</span><span class="fu">print_dplyr_select</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## dplyr::select(
##   granularity_time,
##   granularity_geo,
##   country_iso3,
##   location_code,
##   border,
##   age,
##   sex,
##   date,
##   isoyear,
##   isoweek,
##   isoyearweek,
##   season,
##   seasonweek,
##   calyear,
##   calmonth,
##   calyearmonth,
##   temp_max,
##   temp_min,
##   precip
## ) %&gt;%</code></pre>
<p>Use one of these functions and replace the dplyr::select part in your data selector function. To aggregate data we need location_code, date, temp_max, temp_min, precip, and the granularity_time (dayly, weekly, etc). Comment out the other variables.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L213-L237
## 
## 213 |     dplyr::select(
## 214 |       granularity_time,
## 215 |       # granularity_geo,
## 216 |       # country_iso3,
## 217 |       location_code,
## 218 |       # border,
## 219 |       # age,
## 220 |       # sex,
## 221 | 
## 222 |       date,
## 223 | 
## 224 |       # isoyear,
## 225 |       # isoweek,
## 226 |       # isoyearweek,
## 227 |       # season,
## 228 |       # seasonweek,
## 229 | 
## 230 |       # calyear,
## 231 |       # calmonth,
## 232 |       # calyearmonth,
## 233 | 
## 234 |       temp_max,
## 235 |       temp_min,
## 236 |       precip
## 237 |     ) %&gt;%</code></pre>
</div>
<div id="getting-data-dplyrcollect" class="section level4" number="4.5.3.4">
<h4>
<span class="header-section-number">4.5.3.4</span> Getting data (dplyr::collect)<a class="anchor" aria-label="anchor" href="#getting-data-dplyrcollect"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L238-L238
## 
## 238 |     dplyr::collect() %&gt;%</code></pre>
<p>This executes the SQL call to the database.</p>
</div>
<div id="getting-data-data.table-and-setorder" class="section level4" number="4.5.3.5">
<h4>
<span class="header-section-number">4.5.3.5</span> Getting data (data.table and setorder)<a class="anchor" aria-label="anchor" href="#getting-data-data.table-and-setorder"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L239-L243
## 
## 239 |     as.data.table() %&gt;%
## 240 |     setorder(
## 241 |       location_code,
## 242 |       date
## 243 |     )</code></pre>
<p>Firstly, as a general rule we prefer to use data.table. So we would like to convert our data.frame to a data.table.</p>
<p>Secondly, we are not guaranteed to receive our data in any particular order. Because of this, it is very important that we sort our data on arrival (if this is relevant to the action_fn, e.g. if cumulative sums are created).</p>
</div>
<div id="set-a-name" class="section level4" number="4.5.3.6">
<h4>
<span class="header-section-number">4.5.3.6</span> Set a name<a class="anchor" aria-label="anchor" href="#set-a-name"><i class="fas fa-link"></i></a>
</h4>
<p>Finally give the dataset you return a suitable name for example <code>day_municip</code>.</p>
<p>Check that you data selector function works by saving, restarting, and loading all packages. Then run through the function line by line.</p>
</div>
<div id="example-of-the-data_selector-function" class="section level4" number="4.5.3.7">
<h4>
<span class="header-section-number">4.5.3.7</span> Example of the data_selector function<a class="anchor" aria-label="anchor" href="#example-of-the-data_selector-function"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L184-L251
## 
## 184 | # **** data_selector **** ----
## 185 | #' weather_clean_data (data selector)
## 186 | #' @param argset Argset
## 187 | #' @param schema DB Schema
## 188 | #' @export
## 189 | weather_clean_data_data_selector &lt;- function(argset, schema) {
## 190 |   if (plnr::is_run_directly()) {
## 191 |     # sc::tm_get_plans_argsets_as_dt("weather_clean_data")
## 192 | 
## 193 |     index_plan &lt;- 1
## 194 | 
## 195 |     argset &lt;- sc::tm_get_argset("weather_clean_data", index_plan = index_plan)
## 196 |     schema &lt;- sc::tm_get_schema("weather_clean_data")
## 197 |   }
## 198 | 
## 199 |   # The database schemas can be accessed here
## 200 |   d &lt;- schema$anon_example_weather_rawdata$tbl() %&gt;%
## 201 |     sc::mandatory_db_filter(
## 202 |       granularity_time = "day",
## 203 |       granularity_time_not = NULL,
## 204 |       granularity_geo = "municip",
## 205 |       granularity_geo_not = NULL,
## 206 |       country_iso3 = NULL,
## 207 |       location_code = NULL,
## 208 |       age = "total",
## 209 |       age_not = NULL,
## 210 |       sex = "total",
## 211 |       sex_not = NULL
## 212 |     ) %&gt;%
## 213 |     dplyr::select(
## 214 |       granularity_time,
## 215 |       # granularity_geo,
## 216 |       # country_iso3,
## 217 |       location_code,
## 218 |       # border,
## 219 |       # age,
## 220 |       # sex,
## 221 | 
## 222 |       date,
## 223 | 
## 224 |       # isoyear,
## 225 |       # isoweek,
## 226 |       # isoyearweek,
## 227 |       # season,
## 228 |       # seasonweek,
## 229 | 
## 230 |       # calyear,
## 231 |       # calmonth,
## 232 |       # calyearmonth,
## 233 | 
## 234 |       temp_max,
## 235 |       temp_min,
## 236 |       precip
## 237 |     ) %&gt;%
## 238 |     dplyr::collect() %&gt;%
## 239 |     as.data.table() %&gt;%
## 240 |     setorder(
## 241 |       location_code,
## 242 |       date
## 243 |     )
## 244 | 
## 245 |   # The variable returned must be a named list
## 246 |   retval &lt;- list(
## 247 |     "day_municip" = d
## 248 |   )
## 249 | 
## 250 |   retval
## 251 | }</code></pre>
</div>
</div>
<div id="action_fn-2" class="section level3" number="4.5.4">
<h3>
<span class="header-section-number">4.5.4</span> 4. action_fn<a class="anchor" aria-label="anchor" href="#action_fn-2"><i class="fas fa-link"></i></a>
</h3>
<p>The final step in the process is creating the action function. Replace <code>TASK_NAME</code> with your task name.</p>
<div id="skeleton" class="section level4" number="4.5.4.1">
<h4>
<span class="header-section-number">4.5.4.1</span> Skeleton<a class="anchor" aria-label="anchor" href="#skeleton"><i class="fas fa-link"></i></a>
</h4>
<p>In this action function we use fhi skeletons to create bases for our data tables.
Read <a href="https://folkehelseinstituttet.github.io/fhidata/articles/Skeletons.html">here</a> about the concept of skeletons.</p>
<p>Start by creating a variable (for example d_agg) for an empty list and copy the data collected in the data selector function into this (<code>d_agg$day_municip &lt;- copy(data$day_municip)</code>). Extract the first and last date from this dataset.</p>
<p>Now we are going to create a skeleton for where we separate between regions where we have data (municipalities) and regions where we do not have data (bo og arbeigs regioner). The skeleton function takes min and max dates and in this case we will pass it granularity_geo consisting of a list with</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
          <span class="st">"nodata"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
          <span class="st">"wardoslo"</span>,
          <span class="st">"extrawardoslo"</span>,
          <span class="st">"missingwardoslo"</span>,
          <span class="st">"wardbergen"</span>,
          <span class="st">"missingwardbergen"</span>,
          <span class="st">"wardstavanger"</span>,
          <span class="st">"missingwardstavanger"</span>,
          <span class="st">"notmainlandmunicip"</span>,
          <span class="st">"missingmunicip"</span>,
          <span class="st">"notmainlandcounty"</span>,
          <span class="st">"missingcounty"</span>
        <span class="op">)</span>,
        <span class="st">"municip"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
          <span class="st">"municip"</span>
        <span class="op">)</span>
<span class="op">)</span>
<span class="co">## $nodata</span>
<span class="co">##  [1] "wardoslo"             "extrawardoslo"        "missingwardoslo"      "wardbergen"           "missingwardbergen"    "wardstavanger"       </span>
<span class="co">##  [7] "missingwardstavanger" "notmainlandmunicip"   "missingmunicip"       "notmainlandcounty"    "missingcounty"       </span>
<span class="co">## </span>
<span class="co">## $municip</span>
<span class="co">## [1] "municip"</span></code></pre></div>
</div>
<div id="merge-in-weather-data" class="section level4" number="4.5.4.2">
<h4>
<span class="header-section-number">4.5.4.2</span> Merge in weather data<a class="anchor" aria-label="anchor" href="#merge-in-weather-data"><i class="fas fa-link"></i></a>
</h4>
<p>Next we want to merge the information we have on weather data for the municipalities into this data.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L67-L84
## 
## 67 |   # Merge in the information you have at different geographical granularities
## 68 |   # one level at a time
## 69 |   # municip
## 70 |   multiskeleton_day$municip[
## 71 |     d_agg$day_municip,
## 72 |     on = c("location_code", "date"),
## 73 |     c(
## 74 |       "temp_max",
## 75 |       "temp_min",
## 76 |       "precip"
## 77 |     ) := .(
## 78 |       temp_max,
## 79 |       temp_min,
## 80 |       precip
## 81 |     )
## 82 |   ]
## 83 | 
## 84 |   multiskeleton_day$municip[]</code></pre>
</div>
<div id="aggregate-to-a-county-level" class="section level4" number="4.5.4.3">
<h4>
<span class="header-section-number">4.5.4.3</span> Aggregate to a county level<a class="anchor" aria-label="anchor" href="#aggregate-to-a-county-level"><i class="fas fa-link"></i></a>
</h4>
<p>Now aggregate the data to a county level with the help of <code><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_hierarchy.html">fhidata::norway_locations_hierarchy</a></code></p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L86-L109
## 
##  86 |   # Aggregate up to higher geographical granularities (county)
##  87 |   multiskeleton_day$county &lt;- multiskeleton_day$municip[
##  88 |     fhidata::norway_locations_hierarchy(
##  89 |       from = "municip",
##  90 |       to = "county"
##  91 |     ),
##  92 |     on = c(
##  93 |       "location_code==from_code"
##  94 |     )
##  95 |   ][,
##  96 |     .(
##  97 |       temp_max = mean(temp_max, na.rm = T),
##  98 |       temp_min = mean(temp_min, na.rm = T),
##  99 |       precip = mean(precip, na.rm = T),
## 100 |       granularity_geo = "county"
## 101 |     ),
## 102 |     by = .(
## 103 |       granularity_time,
## 104 |       date,
## 105 |       location_code = to_code
## 106 |     )
## 107 |   ]
## 108 | 
## 109 |   multiskeleton_day$county[]</code></pre>
</div>
<div id="aggregate-to-national-level" class="section level4" number="4.5.4.4">
<h4>
<span class="header-section-number">4.5.4.4</span> Aggregate to national level<a class="anchor" aria-label="anchor" href="#aggregate-to-national-level"><i class="fas fa-link"></i></a>
</h4>
<p>There is no overlap in municipalities, hence aggregating to a national level can be done without the help of <code><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_hierarchy.html">fhidata::norway_locations_hierarchy</a></code>.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L111-L127
## 
## 111 |   # Aggregate up to higher geographical granularities (nation)
## 112 |   multiskeleton_day$nation &lt;- multiskeleton_day$municip[
## 113 |     ,
## 114 |     .(
## 115 |       temp_max = mean(temp_max, na.rm = T),
## 116 |       temp_min = mean(temp_min, na.rm = T),
## 117 |       precip = mean(precip, na.rm = T),
## 118 |       granularity_geo = "nation",
## 119 |       location_code = "norge"
## 120 |     ),
## 121 |     by = .(
## 122 |       granularity_time,
## 123 |       date
## 124 |     )
## 125 |   ]
## 126 | 
## 127 |   multiskeleton_day$nation[]</code></pre>
</div>
<div id="combine-data" class="section level4" number="4.5.4.5">
<h4>
<span class="header-section-number">4.5.4.5</span> Combine data<a class="anchor" aria-label="anchor" href="#combine-data"><i class="fas fa-link"></i></a>
</h4>
<p>Combine all the different granularity geos by using rbindlist and storing it to a new name f.eks skeleton_day.</p>
</div>
<div id="weekly-data." class="section level4" number="4.5.4.6">
<h4>
<span class="header-section-number">4.5.4.6</span> Weekly data.<a class="anchor" aria-label="anchor" href="#weekly-data."><i class="fas fa-link"></i></a>
</h4>
<p>As a challenge try and aggregate the daily data to weekly data! You can use <code>fhiplot::isoyearweek_c(date)</code> to get the isoweek of a date.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L134-L153
## 
## 134 |   # 10. (If desirable) aggregate up to higher time granularities
## 135 |   # if necessary, it is now easy to aggregate up to weekly data from here
## 136 |   skeleton_isoweek &lt;- copy(skeleton_day)
## 137 |   skeleton_isoweek[, isoyearweek := fhiplot::isoyearweek_c(date)]
## 138 |   skeleton_isoweek &lt;- skeleton_isoweek[
## 139 |     ,
## 140 |     .(
## 141 |       temp_max = mean(temp_max, na.rm = T),
## 142 |       temp_min = mean(temp_min, na.rm = T),
## 143 |       precip = mean(precip, na.rm = T),
## 144 |       granularity_time = "isoweek"
## 145 |     ),
## 146 |     keyby = .(
## 147 |       isoyearweek,
## 148 |       granularity_geo,
## 149 |       location_code
## 150 |     )
## 151 |   ]
## 152 | 
## 153 |   skeleton_isoweek[]</code></pre>
</div>
<div id="structural-data" class="section level4" number="4.5.4.7">
<h4>
<span class="header-section-number">4.5.4.7</span> Structural data<a class="anchor" aria-label="anchor" href="#structural-data"><i class="fas fa-link"></i></a>
</h4>
<p>The next step is to fill in all missing structural data. Fill in sex = “total” and age= “total” manually then you can use <code>sc::fill_in_missing_v8(skeleton_day, border = config$border)</code>.
For the weekly data make sure to also convert the date by using <code>as.Date(date)</code> to ensure it is on the right format.</p>
<p>Rbindlist binds the two data tables together.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L155-L173
## 
## 155 |   # we now need to format it and fill in missing structural variables
## 156 |   # day
## 157 |   skeleton_day[, sex := "total"]
## 158 |   skeleton_day[, age := "total"]
## 159 |   sc::fill_in_missing_v8(skeleton_day, border = config$border)
## 160 | 
## 161 |   # isoweek
## 162 |   skeleton_isoweek[, sex := "total"]
## 163 |   skeleton_isoweek[, age := "total"]
## 164 |   sc::fill_in_missing_v8(skeleton_isoweek, border = config$border)
## 165 |   skeleton_isoweek[, date := as.Date(date)]
## 166 | 
## 167 |   skeleton &lt;- rbindlist(
## 168 |     list(
## 169 |       skeleton_day,
## 170 |       skeleton_isoweek
## 171 |     ),
## 172 |     use.names = T
## 173 |   )</code></pre>
</div>
<div id="store-the-data" class="section level4" number="4.5.4.8">
<h4>
<span class="header-section-number">4.5.4.8</span> Store the data<a class="anchor" aria-label="anchor" href="#store-the-data"><i class="fas fa-link"></i></a>
</h4>
<p>Insert the final data table into the database specified in the task description</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L175-L176
## 
## 175 |   # put data in db table
## 176 |   schema$anon_example_weather_data$drop_all_rows_and_then_insert_data(skeleton)</code></pre>
<p>Restart R, load all packages and try and run the task.</p>
<p>Run the entire task by running <code>tm_run_task("weather_clean_data")</code>. If you ran the tasks at the beginning of the script you might need to run <code>schema$anon_example_weather_data$drop_all_rows()</code> first.</p>
</div>
<div id="full-example" class="section level4" number="4.5.4.9">
<h4>
<span class="header-section-number">4.5.4.9</span> Full example<a class="anchor" aria-label="anchor" href="#full-example"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L1-L182
## 
##   1 | # **** action **** ----
##   2 | #' weather_clean_data (action)
##   3 | #' @param data Data
##   4 | #' @param argset Argset
##   5 | #' @param schema DB Schema
##   6 | #' @export
##   7 | weather_clean_data_action &lt;- function(data, argset, schema) {
##   8 |   # tm_run_task("weather_clean_data")
##   9 | 
##  10 |   if (plnr::is_run_directly()) {
##  11 |     # sc::tm_get_plans_argsets_as_dt("weather_clean_data")
##  12 | 
##  13 |     index_plan &lt;- 1
##  14 |     index_analysis &lt;- 1
##  15 | 
##  16 |     data &lt;- sc::tm_get_data("weather_clean_data", index_plan = index_plan)
##  17 |     argset &lt;- sc::tm_get_argset("weather_clean_data", index_plan = index_plan, index_analysis = index_analysis)
##  18 |     schema &lt;- sc::tm_get_schema("weather_clean_data")
##  19 |   }
##  20 | 
##  21 |   # special case that runs before everything
##  22 |   if (argset$first_analysis == TRUE) {
##  23 | 
##  24 |   }
##  25 | 
##  26 |   # make sure there's no missing data via the creation of a skeleton
##  27 |   # https://folkehelseinstituttet.github.io/fhidata/articles/Skeletons.html
##  28 | 
##  29 |   # Create a variable (possibly a list) to hold the data
##  30 |   d_agg &lt;- list()
##  31 |   d_agg$day_municip &lt;- copy(data$day_municip)
##  32 | 
##  33 |   # Pull out important dates
##  34 |   date_min &lt;- min(d_agg$day_municip$date, na.rm = T)
##  35 |   date_max &lt;- max(d_agg$day_municip$date, na.rm = T)
##  36 | 
##  37 |   # Create `multiskeleton`
##  38 |   # granularity_geo should have the following groups:
##  39 |   # - nodata (when no data is available, and there is no "finer" data available to aggregate up)
##  40 |   # - all levels of granularity_geo where you have data available
##  41 |   # If you do not have data for a specific granularity_geo, but there is "finer" data available
##  42 |   # then you should not include this granularity_geo in the multiskeleton, because you will create
##  43 |   # it later when you aggregate up your data (baregion)
##  44 |   multiskeleton_day &lt;- fhidata::make_skeleton(
##  45 |     date_min = date_min,
##  46 |     date_max = date_max,
##  47 |     granularity_geo = list(
##  48 |       "nodata" = c(
##  49 |         "wardoslo",
##  50 |         "extrawardoslo",
##  51 |         "missingwardoslo",
##  52 |         "wardbergen",
##  53 |         "missingwardbergen",
##  54 |         "wardstavanger",
##  55 |         "missingwardstavanger",
##  56 |         "notmainlandmunicip",
##  57 |         "missingmunicip",
##  58 |         "notmainlandcounty",
##  59 |         "missingcounty"
##  60 |       ),
##  61 |       "municip" = c(
##  62 |         "municip"
##  63 |       )
##  64 |     )
##  65 |   )
##  66 | 
##  67 |   # Merge in the information you have at different geographical granularities
##  68 |   # one level at a time
##  69 |   # municip
##  70 |   multiskeleton_day$municip[
##  71 |     d_agg$day_municip,
##  72 |     on = c("location_code", "date"),
##  73 |     c(
##  74 |       "temp_max",
##  75 |       "temp_min",
##  76 |       "precip"
##  77 |     ) := .(
##  78 |       temp_max,
##  79 |       temp_min,
##  80 |       precip
##  81 |     )
##  82 |   ]
##  83 | 
##  84 |   multiskeleton_day$municip[]
##  85 | 
##  86 |   # Aggregate up to higher geographical granularities (county)
##  87 |   multiskeleton_day$county &lt;- multiskeleton_day$municip[
##  88 |     fhidata::norway_locations_hierarchy(
##  89 |       from = "municip",
##  90 |       to = "county"
##  91 |     ),
##  92 |     on = c(
##  93 |       "location_code==from_code"
##  94 |     )
##  95 |   ][,
##  96 |     .(
##  97 |       temp_max = mean(temp_max, na.rm = T),
##  98 |       temp_min = mean(temp_min, na.rm = T),
##  99 |       precip = mean(precip, na.rm = T),
## 100 |       granularity_geo = "county"
## 101 |     ),
## 102 |     by = .(
## 103 |       granularity_time,
## 104 |       date,
## 105 |       location_code = to_code
## 106 |     )
## 107 |   ]
## 108 | 
## 109 |   multiskeleton_day$county[]
## 110 | 
## 111 |   # Aggregate up to higher geographical granularities (nation)
## 112 |   multiskeleton_day$nation &lt;- multiskeleton_day$municip[
## 113 |     ,
## 114 |     .(
## 115 |       temp_max = mean(temp_max, na.rm = T),
## 116 |       temp_min = mean(temp_min, na.rm = T),
## 117 |       precip = mean(precip, na.rm = T),
## 118 |       granularity_geo = "nation",
## 119 |       location_code = "norge"
## 120 |     ),
## 121 |     by = .(
## 122 |       granularity_time,
## 123 |       date
## 124 |     )
## 125 |   ]
## 126 | 
## 127 |   multiskeleton_day$nation[]
## 128 | 
## 129 |   # combine all the different granularity_geos
## 130 |   skeleton_day &lt;- rbindlist(multiskeleton_day, fill = TRUE, use.names = TRUE)
## 131 | 
## 132 |   skeleton_day[]
## 133 | 
## 134 |   # 10. (If desirable) aggregate up to higher time granularities
## 135 |   # if necessary, it is now easy to aggregate up to weekly data from here
## 136 |   skeleton_isoweek &lt;- copy(skeleton_day)
## 137 |   skeleton_isoweek[, isoyearweek := fhiplot::isoyearweek_c(date)]
## 138 |   skeleton_isoweek &lt;- skeleton_isoweek[
## 139 |     ,
## 140 |     .(
## 141 |       temp_max = mean(temp_max, na.rm = T),
## 142 |       temp_min = mean(temp_min, na.rm = T),
## 143 |       precip = mean(precip, na.rm = T),
## 144 |       granularity_time = "isoweek"
## 145 |     ),
## 146 |     keyby = .(
## 147 |       isoyearweek,
## 148 |       granularity_geo,
## 149 |       location_code
## 150 |     )
## 151 |   ]
## 152 | 
## 153 |   skeleton_isoweek[]
## 154 | 
## 155 |   # we now need to format it and fill in missing structural variables
## 156 |   # day
## 157 |   skeleton_day[, sex := "total"]
## 158 |   skeleton_day[, age := "total"]
## 159 |   sc::fill_in_missing_v8(skeleton_day, border = config$border)
## 160 | 
## 161 |   # isoweek
## 162 |   skeleton_isoweek[, sex := "total"]
## 163 |   skeleton_isoweek[, age := "total"]
## 164 |   sc::fill_in_missing_v8(skeleton_isoweek, border = config$border)
## 165 |   skeleton_isoweek[, date := as.Date(date)]
## 166 | 
## 167 |   skeleton &lt;- rbindlist(
## 168 |     list(
## 169 |       skeleton_day,
## 170 |       skeleton_isoweek
## 171 |     ),
## 172 |     use.names = T
## 173 |   )
## 174 | 
## 175 |   # put data in db table
## 176 |   schema$anon_example_weather_data$drop_all_rows_and_then_insert_data(skeleton)
## 177 | 
## 178 |   # special case that runs after everything
## 179 |   if (argset$last_analysis == TRUE) {
## 180 | 
## 181 |   }
## 182 | }</code></pre>
</div>
</div>
</div>
<div id="developing-weather_export_plots" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Developing weather_export_plots<a class="anchor" aria-label="anchor" href="#developing-weather_export_plots"><i class="fas fa-link"></i></a>
</h2>
<p>The final task of this tutorial, weather_export_plots, takes the cleaned data and plots 11 graphs (one for each county) of min and max temperatures.
This means we need 11 plans, one for each county. We use input data generated by data clean_weather_data. Hence, we do not need to create a new schema. We are going to pass a few universal argset through the task definition to define the location to store the figures.</p>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_clean_data.r#L84-L88
## 
## 84 |   multiskeleton_day$municip[]
## 85 | 
## 86 |   # Aggregate up to higher geographical granularities (county)
## 87 |   multiskeleton_day$county &lt;- multiskeleton_day$municip[
## 88 |     fhidata::norway_locations_hierarchy(</code></pre>
<p>The benefits of placing the output directories and filenames in the task declaration are:</p>
<ul>
<li>It makes your action_fn more generic, and can be reused by multiple tasks</li>
<li>It is easier to get an overview of where the output is being sent</li>
<li>“More decisions” in the task config and “fewer decisions” in the action_fn makes the system easier for everyone to understand, because decisions become more explicit</li>
</ul>
<p>Everything inside the curly brackets get passed through the action function.</p>
<p>Each plan only need the data for that specific location_code. This can be implemented in the manditory filters in the data selector function.</p>
<p><code>fs::dir_create(glue::glue(argset$output_dir))</code> can be used to create the output directory.</p>
<p>Try putting everything you have learned so fare together and create this task by yourself. If you get stuck you can always peak below. Good luck!</p>
<div id="schemas-4" class="section level3" number="4.6.1">
<h3>
<span class="header-section-number">4.6.1</span> 1. Schemas<a class="anchor" aria-label="anchor" href="#schemas-4"><i class="fas fa-link"></i></a>
</h3>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/03_db_schemas.r#L66-L112
## 
##  66 |   ## &gt; anon_example_weather_data ----
##  67 |   sc::add_schema_v8(
##  68 |     name_access = c("anon"),
##  69 |     name_grouping = "example_weather",
##  70 |     name_variant = "data",
##  71 |     db_configs = sc::config$db_configs,
##  72 |     field_types =  c(
##  73 |       "granularity_time" = "TEXT",
##  74 |       "granularity_geo" = "TEXT",
##  75 |       "country_iso3" = "TEXT",
##  76 |       "location_code" = "TEXT",
##  77 |       "border" = "INTEGER",
##  78 |       "age" = "TEXT",
##  79 |       "sex" = "TEXT",
##  80 | 
##  81 |       "date" = "DATE",
##  82 | 
##  83 |       "isoyear" = "INTEGER",
##  84 |       "isoweek" = "INTEGER",
##  85 |       "isoyearweek" = "TEXT",
##  86 |       "season" = "TEXT",
##  87 |       "seasonweek" = "DOUBLE",
##  88 | 
##  89 |       "calyear" = "INTEGER",
##  90 |       "calmonth" = "INTEGER",
##  91 |       "calyearmonth" = "TEXT",
##  92 | 
##  93 |       "temp_max" = "DOUBLE",
##  94 |       "temp_min" = "DOUBLE",
##  95 |       "precip" = "DOUBLE"
##  96 |     ),
##  97 |     keys = c(
##  98 |       "granularity_time",
##  99 |       "location_code",
## 100 |       "date",
## 101 |       "age",
## 102 |       "sex"
## 103 |     ),
## 104 |     censors = list(
## 105 |       anon = list(
## 106 | 
## 107 |       )
## 108 |     ),
## 109 |     validator_field_types = sc::validator_field_types_sykdomspulsen,
## 110 |     validator_field_contents = sc::validator_field_contents_sykdomspulsen,
## 111 |     info = "This db table is used for..."
## 112 |   )</code></pre>
<p>This schema has already been created by the previous task <code>weather_clean_data</code>.</p>
</div>
<div id="task-definition-task_from_config-2" class="section level3" number="4.6.2">
<h3>
<span class="header-section-number">4.6.2</span> 2. Task definition (task_from_config)<a class="anchor" aria-label="anchor" href="#task-definition-task_from_config-2"><i class="fas fa-link"></i></a>
</h3>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L72-L100
## 
##  72 |   ## &gt; weather_clean_data ----
##  73 |   # tm_run_task("weather_export_plots")
##  74 |   sc::add_task_from_config_v8(
##  75 |     name_grouping = "weather",
##  76 |     name_action = "export_plots",
##  77 |     name_variant = NULL,
##  78 |     cores = 1,
##  79 |     plan_analysis_fn_name = NULL,
##  80 |     for_each_plan = plnr::expand_list(
##  81 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("county")]$location_code
##  82 |     ),
##  83 |     for_each_analysis = NULL,
##  84 |     universal_argset = list(
##  85 |       output_dir = tempdir(),
##  86 |       output_filename = "weather_{argset$location_code}.png",
##  87 |       output_absolute_path = fs::path("{argset$output_dir}", "{argset$output_filename}")
##  88 |     ),
##  89 |     upsert_at_end_of_each_plan = FALSE,
##  90 |     insert_at_end_of_each_plan = FALSE,
##  91 |     action_fn_name = "scexample::weather_export_plots_action",
##  92 |     data_selector_fn_name = "scexample::weather_export_plots_data_selector",
##  93 |     schema = list(
##  94 |       # input
##  95 |       "anon_example_weather_data" = sc::config$schemas$anon_example_weather_data
##  96 | 
##  97 |       # output
##  98 |     ),
##  99 |     info = "This task ploduces plots"
## 100 |   )</code></pre>
<div id="plananalysis-structure-2" class="section level4" number="4.6.2.1">
<h4>
<span class="header-section-number">4.6.2.1</span> Plan/analysis structure<a class="anchor" aria-label="anchor" href="#plananalysis-structure-2"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L79-L83
## 
## 79 |     plan_analysis_fn_name = NULL,
## 80 |     for_each_plan = plnr::expand_list(
## 81 |       location_code = fhidata::norway_locations_names()[granularity_geo %in% c("county")]$location_code
## 82 |     ),
## 83 |     for_each_analysis = NULL,</code></pre>
<p>Here we choose a plan-heavy approach (11 plans, 1 analysis per plan) to minimize the amount of data loaded into RAM at any point in time.</p>
</div>
<div id="universal-argset-1" class="section level4" number="4.6.2.2">
<h4>
<span class="header-section-number">4.6.2.2</span> Universal argset<a class="anchor" aria-label="anchor" href="#universal-argset-1"><i class="fas fa-link"></i></a>
</h4>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/04_tasks.r#L84-L88
## 
## 84 |     universal_argset = list(
## 85 |       output_dir = tempdir(),
## 86 |       output_filename = "weather_{argset$location_code}.png",
## 87 |       output_absolute_path = fs::path("{argset$output_dir}", "{argset$output_filename}")
## 88 |     ),</code></pre>
</div>
</div>
<div id="data_selector_fn-3" class="section level3" number="4.6.3">
<h3>
<span class="header-section-number">4.6.3</span> 3. data_selector_fn<a class="anchor" aria-label="anchor" href="#data_selector_fn-3"><i class="fas fa-link"></i></a>
</h3>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_export_plots.r#L45-L110
## 
##  45 | # **** data_selector **** ----
##  46 | #' weather_export_plots (data selector)
##  47 | #' @param argset Argset
##  48 | #' @param schema DB Schema
##  49 | #' @export
##  50 | weather_export_plots_data_selector = function(argset, schema){
##  51 |   if(plnr::is_run_directly()){
##  52 |     # sc::tm_get_plans_argsets_as_dt("weather_export_plots")
##  53 | 
##  54 |     index_plan &lt;- 1
##  55 | 
##  56 |     argset &lt;- sc::tm_get_argset("weather_export_plots", index_plan = index_plan)
##  57 |     schema &lt;- sc::tm_get_schema("weather_export_plots")
##  58 |   }
##  59 | 
##  60 |   # The database schemas can be accessed here
##  61 |   d &lt;- schema$anon_example_weather_data$tbl() %&gt;%
##  62 |     sc::mandatory_db_filter(
##  63 |       granularity_time = NULL,
##  64 |       granularity_time_not = NULL,
##  65 |       granularity_geo = NULL,
##  66 |       granularity_geo_not = NULL,
##  67 |       country_iso3 = NULL,
##  68 |       location_code = argset$location_code,
##  69 |       age = NULL,
##  70 |       age_not = NULL,
##  71 |       sex = NULL,
##  72 |       sex_not = NULL
##  73 |     ) %&gt;%
##  74 |     dplyr::select(
##  75 |       # granularity_time,
##  76 |       # granularity_geo,
##  77 |       # country_iso3,
##  78 |       # location_code,
##  79 |       # border,
##  80 |       # age,
##  81 |       # sex,
##  82 | 
##  83 |       date,
##  84 | 
##  85 |       # isoyear,
##  86 |       # isoweek,
##  87 |       # isoyearweek,
##  88 |       # season,
##  89 |       # seasonweek,
##  90 |       #
##  91 |       # calyear,
##  92 |       # calmonth,
##  93 |       # calyearmonth,
##  94 | 
##  95 |       temp_max,
##  96 |       temp_min
##  97 |     ) %&gt;%
##  98 |     dplyr::collect() %&gt;%
##  99 |     as.data.table() %&gt;%
## 100 |     setorder(
## 101 |       # location_code,
## 102 |       date
## 103 |     )
## 104 | 
## 105 |   # The variable returned must be a named list
## 106 |   retval &lt;- list(
## 107 |     "data" = d
## 108 |   )
## 109 |   retval
## 110 | }</code></pre>
</div>
<div id="action_fn-3" class="section level3" number="4.6.4">
<h3>
<span class="header-section-number">4.6.4</span> 4. action_fn<a class="anchor" aria-label="anchor" href="#action_fn-3"><i class="fas fa-link"></i></a>
</h3>
<pre><code>## https://github.com/sykdomspulsen-org/sc-tutorial-end/blob/main/R/weather_export_plots.r#L1-L43
## 
##  1 | # **** action **** ----
##  2 | #' weather_export_plots (action)
##  3 | #' @param data Data
##  4 | #' @param argset Argset
##  5 | #' @param schema DB Schema
##  6 | #' @export
##  7 | weather_export_plots_action &lt;- function(data, argset, schema) {
##  8 |   # tm_run_task("weather_export_plots")
##  9 | 
## 10 |   if(plnr::is_run_directly()){
## 11 |     # sc::tm_get_plans_argsets_as_dt("weather_export_plots")
## 12 | 
## 13 |     index_plan &lt;- 1
## 14 |     index_analysis &lt;- 1
## 15 | 
## 16 |     data &lt;- sc::tm_get_data("weather_export_plots", index_plan = index_plan)
## 17 |     argset &lt;- sc::tm_get_argset("weather_export_plots", index_plan = index_plan, index_analysis = index_analysis)
## 18 |     schema &lt;- sc::tm_get_schema("weather_export_plots")
## 19 |   }
## 20 | 
## 21 |   # code goes here
## 22 |   # special case that runs before everything
## 23 |   if(argset$first_analysis == TRUE){
## 24 | 
## 25 |   }
## 26 | 
## 27 |   # create the output_dir (if it doesn't exist)
## 28 |   fs::dir_create(glue::glue(argset$output_dir))
## 29 | 
## 30 |   q &lt;- ggplot(data$data, aes(x = date, ymin = temp_min, ymax = temp_max))
## 31 |   q &lt;- q + geom_ribbon(alpha = 0.5)
## 32 | 
## 33 |   ggsave(
## 34 |     filename = glue::glue(argset$output_absolute_path),
## 35 |     plot = q
## 36 |   )
## 37 | 
## 38 |   # special case that runs after everything
## 39 |   # copy to anon_web?
## 40 |   if(argset$last_analysis == TRUE){
## 41 | 
## 42 |   }
## 43 | }</code></pre>
</div>
</div>
<div id="final-package" class="section level2" number="4.7">
<h2>
<span class="header-section-number">4.7</span> Final package<a class="anchor" aria-label="anchor" href="#final-package"><i class="fas fa-link"></i></a>
</h2>
<p>If you save, restart and load all all packages you can now see which schemas have been loaded by running <code><a href="https://rdrr.io/pkg/sc/man/tm_get_schema_names.html">sc::tm_get_schema_names()</a></code>. You can now see that the schemas you made are included.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sc/man/tm_get_schema_names.html">tm_get_schema_names</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] "config_last_updated"                                           "config_structure_time"                                        </span>
<span class="co">## [3] "rundate"                                                       "config_datetime"                                              </span>
<span class="co">## [5] "anon_example_weather_rawdata"                                  "anon_example_weather_data"                                    </span>
<span class="co">## [7] "anon_example_income"                                           "anon_example_house_prices"                                    </span>
<span class="co">## [9] "anon_example_house_prices_outliers_after_adjusting_for_income"</span></code></pre></div>
<p>You can alsp see which tasks have been loaded by running <code><a href="https://rdrr.io/pkg/sc/man/tm_get_task_names.html">sc::tm_get_task_names()</a></code>. These tasks are included in the skeleton.</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sc/man/tm_get_task_names.html">tm_get_task_names</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] "weather_download_and_import_rawdata"                            "weather_clean_data"                                            </span>
<span class="co">## [3] "weather_export_plots"                                           "household_incomes_and_house_prices_import_data"                </span>
<span class="co">## [5] "household_incomes_and_house_prices_fit_model_and_find_outliers" "household_incomes_and_house_prices_plot"</span></code></pre></div>
<div id="running" class="section level3" number="4.7.1">
<h3>
<span class="header-section-number">4.7.1</span> Running<a class="anchor" aria-label="anchor" href="#running"><i class="fas fa-link"></i></a>
</h3>
<p>You can now run these tasks in your console if you want. Note that we use <code>scskeleton::tm_run_task</code> instead of <code><a href="https://rdrr.io/pkg/sc/man/tm_run_task.html">sc::tm_run_task</a></code>. This is because we want to ensure that <code>scexample::.onLoad</code> has been called which authenticates you.</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">scskeleton</span><span class="fu">::</span><span class="fu">tm_run_task</span><span class="op">(</span><span class="st">"weather_download_and_import_rawdata"</span><span class="op">)</span>
<span class="fu">scskeleton</span><span class="fu">::</span><span class="fu">tm_run_task</span><span class="op">(</span><span class="st">"weather_clean_data"</span><span class="op">)</span>
<span class="fu">scskeleton</span><span class="fu">::</span><span class="fu">tm_run_task</span><span class="op">(</span><span class="st">"weather_export_weather_plots"</span><span class="op">)</span></code></pre></div>
<p>Congratulations! You have now successfully finnished your first tutorial on Sykdomspulsen Core.</p>
</div>
</div>
<div id="what-now" class="section level2" number="4.8">
<h2>
<span class="header-section-number">4.8</span> What now?<a class="anchor" aria-label="anchor" href="#what-now"><i class="fas fa-link"></i></a>
</h2>
<p>After Tutorial 1, we expect that you understand the four fundamental parts of developing a task:</p>
<ol style="list-style-type: decimal">
<li>Schemas</li>
<li>Task definition (task_from_config)</li>
<li>data_selector_fn</li>
<li>action_fn</li>
</ol>
<p>We also expect that you can:</p>
<ol style="list-style-type: decimal">
<li>Run a task using <code>tm_run_task</code>
</li>
<li>Use <code><a href="https://rdrr.io/pkg/sc/man/tm_get_plans_argsets_as_dt.html">sc::tm_get_plans_argsets_as_dt</a></code> to identify which <code>index_plan</code> and <code>index_analysis</code> corresponds to the plan/analysis you are interested in (e.g. Oslo)</li>
<li>Run the inside code of a <code>data_selector_fn</code> for different <code>index_plan</code>s as if it were an interactive script</li>
<li>Run the inside code of an <code>action_fn</code> for different <code>index_plan</code>s and <code>index_analysis</code>s as if it were an interactive script</li>
</ol>
<!-- Tutorial 2 will challenge you to start creating your own tasks to solve problems. -->
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="file-layout.html"><span class="header-section-number">3</span> File Layout</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#tutorial-1-introduction"><span class="header-section-number">4</span> Tutorial 1: Introduction</a></li>
<li><a class="nav-link" href="#setup"><span class="header-section-number">4.1</span> Setup</a></li>
<li><a class="nav-link" href="#load-the-code"><span class="header-section-number">4.2</span> Load the code</a></li>
<li><a class="nav-link" href="#weather-data-example"><span class="header-section-number">4.3</span> Weather data example</a></li>
<li>
<a class="nav-link" href="#developing-weather_download_and_import_rawdata"><span class="header-section-number">4.4</span> Developing weather_download_and_import_rawdata</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#schemas"><span class="header-section-number">4.4.1</span> 1. Schemas</a></li>
<li><a class="nav-link" href="#task-definition-task_from_config"><span class="header-section-number">4.4.2</span> 2. Task definition (task_from_config)</a></li>
<li><a class="nav-link" href="#universal-argset"><span class="header-section-number">4.4.3</span> Universal argset</a></li>
<li><a class="nav-link" href="#data_selector_fn-1"><span class="header-section-number">4.4.4</span> 3. data_selector_fn</a></li>
<li><a class="nav-link" href="#getting-data"><span class="header-section-number">4.4.5</span> Getting data</a></li>
<li><a class="nav-link" href="#returning-data"><span class="header-section-number">4.4.6</span> Returning data</a></li>
<li><a class="nav-link" href="#action_fn-1"><span class="header-section-number">4.4.7</span> 4. action_fn</a></li>
<li><a class="nav-link" href="#test-the-code"><span class="header-section-number">4.4.8</span> Test the code</a></li>
<li><a class="nav-link" href="#which-plananalysis-is-which"><span class="header-section-number">4.4.9</span> Which plan/analysis is which?</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#developing-weather_clean_data"><span class="header-section-number">4.5</span> Developing weather_clean_data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#schemas-2"><span class="header-section-number">4.5.1</span> 1. Schemas</a></li>
<li><a class="nav-link" href="#task-definition-task_from_config-1"><span class="header-section-number">4.5.2</span> 2. Task definition (task_from_config)</a></li>
<li><a class="nav-link" href="#data_selector_fn-2"><span class="header-section-number">4.5.3</span> 3. data_selector_fn</a></li>
<li><a class="nav-link" href="#action_fn-2"><span class="header-section-number">4.5.4</span> 4. action_fn</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#developing-weather_export_plots"><span class="header-section-number">4.6</span> Developing weather_export_plots</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#schemas-4"><span class="header-section-number">4.6.1</span> 1. Schemas</a></li>
<li><a class="nav-link" href="#task-definition-task_from_config-2"><span class="header-section-number">4.6.2</span> 2. Task definition (task_from_config)</a></li>
<li><a class="nav-link" href="#data_selector_fn-3"><span class="header-section-number">4.6.3</span> 3. data_selector_fn</a></li>
<li><a class="nav-link" href="#action_fn-3"><span class="header-section-number">4.6.4</span> 4. action_fn</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#final-package"><span class="header-section-number">4.7</span> Final package</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#running"><span class="header-section-number">4.7.1</span> Running</a></li></ul>
</li>
<li><a class="nav-link" href="#what-now"><span class="header-section-number">4.8</span> What now?</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Sykdomspulsen Core in Depth</strong>" was written by members of the Sykdomspulsen Team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
